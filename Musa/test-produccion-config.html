<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Test de Configuraci√≥n Producci√≥n MercadoPago</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h4><i class="fas fa-check-circle"></i> Test de Configuraci√≥n Producci√≥n MercadoPago</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong><i class="fas fa-info-circle"></i> Estado de la Plataforma:</strong>
                            Esta p√°gina verifica que la configuraci√≥n de producci√≥n est√© correcta.
                        </div>

                        <div id="test-results">
                            <h5>üîç Resultados de Verificaci√≥n:</h5>
                            <div id="config-status" class="mb-3">
                                <p><i class="fas fa-spinner fa-spin"></i> Verificando configuraci√≥n...</p>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button id="test-payment-flow" class="btn btn-success me-2">
                                <i class="fas fa-credit-card"></i> Probar Flujo de Pago
                            </button>
                            <button id="reload-test" class="btn btn-secondary">
                                <i class="fas fa-refresh"></i> Verificar Nuevamente
                            </button>
                        </div>

                        <div class="mt-4">
                            <div class="card">
                                <div class="card-header">
                                    <strong>üìã Lista de Verificaci√≥n:</strong>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Credenciales de Producci√≥n Configuradas
                                            <span id="check-credentials" class="badge bg-secondary">Verificando...</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Ambiente Configurado a 'production'
                                            <span id="check-environment" class="badge bg-secondary">Verificando...</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Frontend con Public Key de Producci√≥n
                                            <span id="check-frontend" class="badge bg-secondary">Verificando...</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Backend con Access Token de Producci√≥n
                                            <span id="check-backend" class="badge bg-secondary">Verificando...</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Simulaci√≥n de Testing Deshabilitada
                                            <span id="check-simulation" class="badge bg-secondary">Verificando...</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 alert alert-warning">
                            <strong><i class="fas fa-exclamation-triangle"></i> ¬°IMPORTANTE!</strong>
                            <p class="mb-0">Ahora est√°s en <strong>MODO PRODUCCI√ìN</strong>. Los pagos que se procesen ser√°n <strong>REALES</strong> y se descontar√° dinero real de las tarjetas de cr√©dito.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            verifyProductionSetup();

            document.getElementById('test-payment-flow').addEventListener('click', function() {
                window.location.href = 'pago-premium.html';
            });

            document.getElementById('reload-test').addEventListener('click', function() {
                location.reload();
            });
        });

        async function verifyProductionSetup() {
            console.log('üîç Verificando configuraci√≥n de producci√≥n...');

            // 1. Verificar credenciales en configuraci√≥n
            try {
                const configResponse = await fetch('config/mercadopago.php?get_config=true');
                const config = await configResponse.json();
                
                if (config.environment === 'production' && 
                    config.public_key && 
                    config.public_key.startsWith('APP_USR-')) {
                    updateCheckStatus('check-credentials', 'success', '‚úÖ Configuradas');
                    updateCheckStatus('check-environment', 'success', '‚úÖ Producci√≥n');
                } else {
                    updateCheckStatus('check-credentials', 'danger', '‚ùå Error');
                    updateCheckStatus('check-environment', 'danger', '‚ùå Error');
                }
            } catch (error) {
                updateCheckStatus('check-credentials', 'danger', '‚ùå Error');
                updateCheckStatus('check-environment', 'danger', '‚ùå Error');
                console.error('Error verificando config:', error);
            }

            // 2. Verificar frontend
            try {
                const frontendResponse = await fetch('pago-premium.html');
                const frontendCode = await frontendResponse.text();
                
                if (frontendCode.includes('APP_USR-3ad42f77-3f44-427e-8dee-ce7a0f84eeae') &&
                    frontendCode.includes('PRODUCCI√ìN') &&
                    !frontendCode.includes('showTestingSimulation')) {
                    updateCheckStatus('check-frontend', 'success', '‚úÖ Configurado');
                    updateCheckStatus('check-simulation', 'success', '‚úÖ Deshabilitada');
                } else {
                    updateCheckStatus('check-frontend', 'danger', '‚ùå Error');
                    updateCheckStatus('check-simulation', 'danger', '‚ùå Activa');
                }
            } catch (error) {
                updateCheckStatus('check-frontend', 'danger', '‚ùå Error');
                console.error('Error verificando frontend:', error);
            }

            // 3. Verificar backend
            try {
                const backendResponse = await fetch('api/process-payment.php');
                const backendCode = await backendResponse.text();
                
                if (backendCode.includes('APP_USR-6153740999578703') &&
                    backendCode.includes('PRODUCCI√ìN')) {
                    updateCheckStatus('check-backend', 'success', '‚úÖ Configurado');
                } else {
                    updateCheckStatus('check-backend', 'danger', '‚ùå Error');
                }
            } catch (error) {
                updateCheckStatus('check-backend', 'warning', '‚ö†Ô∏è No verificable');
                console.error('Error verificando backend:', error);
            }

            // Mostrar resumen final
            setTimeout(() => {
                const allChecks = document.querySelectorAll('[id^="check-"]');
                let successCount = 0;
                let totalChecks = allChecks.length;

                allChecks.forEach(check => {
                    if (check.classList.contains('bg-success')) {
                        successCount++;
                    }
                });

                const statusDiv = document.getElementById('config-status');
                if (successCount === totalChecks) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong><i class="fas fa-check-circle"></i> ¬°Perfecto!</strong>
                            Tu plataforma est√° completamente configurada para producci√≥n.
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <strong><i class="fas fa-exclamation-triangle"></i> Atenci√≥n:</strong>
                            ${successCount}/${totalChecks} verificaciones exitosas. Revisa los elementos marcados en rojo.
                        </div>
                    `;
                }
            }, 2000);
        }

        function updateCheckStatus(elementId, type, text) {
            const element = document.getElementById(elementId);
            element.className = `badge bg-${type}`;
            element.textContent = text;
        }
    </script>
</body>
</html>