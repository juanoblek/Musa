<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Final - Video Chaqueta See</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>üîß Debug Final - Video Chaqueta See</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h3>üìã Informaci√≥n del Sistema</h3>
                <div id="systemInfo"></div>
            </div>
            
            <div class="col-md-6">
                <h3>üé¨ Test de Video</h3>
                <div id="videoTest"></div>
            </div>
        </div>
        
        <div class="mt-4">
            <h3>üîÑ Acciones de Debug</h3>
            <button class="btn btn-primary me-2" onclick="reloadProducts()">üîÑ Recargar Productos</button>
            <button class="btn btn-success me-2" onclick="checkDetector()">üß† Verificar Detector</button>
            <button class="btn btn-warning me-2" onclick="clearCache()">üóëÔ∏è Limpiar Cache</button>
        </div>
        
        <div class="mt-4">
            <h3>üìä Resultados</h3>
            <div id="debugResults"></div>
        </div>
    </div>

    <script src="js/detector-inteligente-media.js"></script>
    
    <script>
        // Informaci√≥n del sistema
        function showSystemInfo() {
            const info = {
                'Detector Inteligente': typeof generarMediaHTMLSincrono !== 'undefined' ? '‚úÖ Cargado' : '‚ùå No cargado',
                'Funci√≥n S√≠ncrona': typeof detectarTipoMediaSincrono !== 'undefined' ? '‚úÖ Disponible' : '‚ùå No disponible',
                'Clase Detector': typeof MediaDetectorInteligente !== 'undefined' ? '‚úÖ Disponible' : '‚ùå No disponible',
                'User Agent': navigator.userAgent,
                'URL Actual': window.location.href,
                'Timestamp': new Date().toLocaleString()
            };
            
            let html = '<div class="card"><div class="card-body">';
            for (const [key, value] of Object.entries(info)) {
                html += `<p><strong>${key}:</strong> ${value}</p>`;
            }
            html += '</div></div>';
            
            document.getElementById('systemInfo').innerHTML = html;
        }

        // Test de video espec√≠fico
        function testVideo() {
            const testUrls = [
                'uploads/chaqueta_see_video.mp4',
                'uploads/video_chaqueta.mov',
                'uploads/test.mp4',
                'uploads/producto_video.webm'
            ];
            
            let html = '<div class="card"><div class="card-body">';
            html += '<h6>URLs de prueba:</h6>';
            
            testUrls.forEach(url => {
                const tipo = detectarTipoMediaSincrono(url);
                const mediaHTML = generarMediaHTMLSincrono(url, 'Test Video', 'w-100', 'max-height: 150px;');
                
                html += `
                    <div class="border p-2 mb-2">
                        <p><strong>URL:</strong> ${url}</p>
                        <p><strong>Tipo:</strong> ${tipo}</p>
                        <div>${mediaHTML}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            document.getElementById('videoTest').innerHTML = html;
        }

        // Recargar productos
        async function reloadProducts() {
            try {
                const response = await fetch('api/productos-v2.php?_cache_bust=' + Date.now());
                const data = await response.json();
                
                let html = '<div class="alert alert-success">';
                html += `<h6>‚úÖ Productos recargados: ${data.data ? data.data.length : 0}</h6>`;
                
                if (data.data) {
                    const chaquetas = data.data.filter(p => 
                        p.name.toLowerCase().includes('chaqueta') || 
                        p.name.toLowerCase().includes('see')
                    );
                    
                    html += `<p>Chaquetas encontradas: ${chaquetas.length}</p>`;
                    
                    chaquetas.forEach(product => {
                        const tipo = detectarTipoMediaSincrono(product.main_image);
                        html += `<p>‚Ä¢ ${product.name}: ${product.main_image} (${tipo})</p>`;
                    });
                }
                
                html += '</div>';
                document.getElementById('debugResults').innerHTML = html;
                
            } catch (error) {
                document.getElementById('debugResults').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>‚ùå Error al recargar productos</h6>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Verificar detector
        function checkDetector() {
            let html = '<div class="alert alert-info">';
            html += '<h6>üß† Estado del Detector Inteligente</h6>';
            
            // Tests b√°sicos
            const tests = [
                { url: 'test.mp4', expected: 'video' },
                { url: 'test.jpg', expected: 'image' },
                { url: 'test.png', expected: 'image' },
                { url: 'test.mov', expected: 'video' }
            ];
            
            tests.forEach(test => {
                const result = detectarTipoMediaSincrono(test.url);
                const status = result === test.expected ? '‚úÖ' : '‚ùå';
                html += `<p>${status} ${test.url} ‚Üí ${result} (esperado: ${test.expected})</p>`;
            });
            
            html += '</div>';
            document.getElementById('debugResults').innerHTML = html;
        }

        // Limpiar cache
        function clearCache() {
            // Limpiar cache del navegador
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // Recargar con par√°metros de cache busting
            const url = new URL(window.location);
            url.searchParams.set('_cache_bust', Date.now());
            
            document.getElementById('debugResults').innerHTML = `
                <div class="alert alert-warning">
                    <h6>üóëÔ∏è Cache limpiado</h6>
                    <p>Recargando p√°gina...</p>
                </div>
            `;
            
            setTimeout(() => {
                window.location.href = url.toString();
            }, 1000);
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            showSystemInfo();
            testVideo();
            
            // Auto-recargar productos al cargar
            setTimeout(reloadProducts, 1000);
        });
    </script>
</body>
</html>