<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Conexi√≥n - Vista Pedidos Completos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #bee5eb;
        }
        
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #e9ecef;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç Prueba de Integraci√≥n - Vista Pedidos Completos</h1>
        <p>Esta p√°gina verifica que tu formulario de pago premium pueda conectarse correctamente con la tabla <code>vista_pedidos_completos</code>.</p>
        
        <div id="results"></div>
        
        <div class="test-section">
            <h3>üìã Pasos para la Integraci√≥n:</h3>
            <ol>
                <li><strong>Crear tablas base:</strong> Ejecuta el archivo <code>crear_tablas_base_vista.sql</code> en phpMyAdmin</li>
                <li><strong>Verificar conexi√≥n:</strong> Haz clic en "Probar Conexi√≥n BD"</li>
                <li><strong>Probar inserci√≥n:</strong> Haz clic en "Simular Pedido"</li>
                <li><strong>Verificar vista:</strong> Haz clic en "Consultar Vista"</li>
                <li><strong>Probar formulario:</strong> Ve a <a href="pago-premium.html" target="_blank">pago-premium.html</a></li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>üß™ Pruebas Disponibles:</h3>
            <button onclick="probarConexion()">üîå Probar Conexi√≥n BD</button>
            <button onclick="simularPedido()">üì¶ Simular Pedido</button>
            <button onclick="consultarVista()">üëÅÔ∏è Consultar Vista</button>
            <button onclick="verificarFormulario()">üìù Verificar Formulario</button>
        </div>
        
        <div class="test-section">
            <h3>üìä Estado de la Base de Datos:</h3>
            <div id="database-status">
                <p>Haz clic en "Probar Conexi√≥n BD" para verificar el estado</p>
            </div>
        </div>
    </div>

    <script>
        async function probarConexion() {
            mostrarCargando('Probando conexi√≥n...');
            
            try {
                const response = await fetch('api/test-connection.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({action: 'test_connection'})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mostrarResultado('success', '‚úÖ Conexi√≥n exitosa', 
                        `Base de datos: ${data.database}<br>
                         Tablas encontradas: ${data.tables.join(', ')}<br>
                         Vista disponible: ${data.vista_exists ? 'S√≠' : 'No'}`);
                } else {
                    mostrarResultado('error', '‚ùå Error de conexi√≥n', data.message);
                }
                
            } catch (error) {
                mostrarResultado('error', '‚ùå Error de red', error.message);
            }
        }
        
        async function simularPedido() {
            mostrarCargando('Simulando pedido...');
            
            const pedidoEjemplo = {
                fullName: 'Cliente de Prueba',
                email: 'prueba@email.com',
                phone: '+57 300 123 4567',
                department: 'Antioquia',
                city: 'Medell√≠n',
                address: 'Calle de Prueba #123-45',
                postalCode: '050001',
                productos: '[{"nombre": "Vestido de Prueba", "precio": 89000, "cantidad": 1}]',
                subtotal: 89000,
                envio: 15000,
                total: 104000,
                paymentMethod: 'credit_card',
                cardHolder: 'Cliente Prueba',
                documentType: 'CC',
                idNumber: '12345678'
            };
            
            try {
                const response = await fetch('api/guardar-pedido.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pedidoEjemplo)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mostrarResultado('success', '‚úÖ Pedido simulado exitosamente', 
                        `Pedido ID: ${data.pedido_id}<br>
                         Total: $${data.total?.toLocaleString()}`);
                } else {
                    mostrarResultado('error', '‚ùå Error al simular pedido', data.message);
                }
                
            } catch (error) {
                mostrarResultado('error', '‚ùå Error en simulaci√≥n', error.message);
            }
        }
        
        async function consultarVista() {
            mostrarCargando('Consultando vista_pedidos_completos...');
            
            try {
                const response = await fetch('api/test-connection.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({action: 'query_vista'})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let html = `‚úÖ Vista consultada exitosamente<br>
                                Registros encontrados: ${data.count}<br><br>`;
                    
                    if (data.registros && data.registros.length > 0) {
                        html += '<strong>√öltimos pedidos:</strong><br>';
                        data.registros.forEach(registro => {
                            html += `üì¶ ${registro.pedido_id} - ${registro.nombre_completo} - $${registro.total}<br>`;
                        });
                    }
                    
                    mostrarResultado('success', 'Vista consultada', html);
                } else {
                    mostrarResultado('error', '‚ùå Error al consultar vista', data.message);
                }
                
            } catch (error) {
                mostrarResultado('error', '‚ùå Error de consulta', error.message);
            }
        }
        
        function verificarFormulario() {
            mostrarResultado('info', 'üìù Verificaci√≥n del Formulario', 
                `<strong>URL del formulario:</strong> <a href="pago-premium.html" target="_blank">http://localhost/Musa/pago-premium.html</a><br><br>
                 <strong>Archivo de procesamiento:</strong> api/guardar-pedido.php<br>
                 <strong>Base de datos:</strong> musa_moda<br>
                 <strong>Vista:</strong> vista_pedidos_completos<br><br>
                 
                 <strong>¬øQu√© probar?</strong><br>
                 1. Llenar el formulario completamente<br>
                 2. Seleccionar m√©todo de pago<br>
                 3. Enviar el pedido<br>
                 4. Verificar que aparezca en el panel administrativo`);
        }
        
        function mostrarCargando(mensaje) {
            document.getElementById('results').innerHTML = 
                `<div class="info">‚è≥ ${mensaje}</div>`;
        }
        
        function mostrarResultado(tipo, titulo, mensaje) {
            document.getElementById('results').innerHTML = 
                `<div class="${tipo}"><strong>${titulo}</strong><br>${mensaje}</div>`;
        }
        
        // Auto-ejecutar prueba de conexi√≥n al cargar
        window.onload = function() {
            probarConexion();
        };
    </script>
</body>
</html>