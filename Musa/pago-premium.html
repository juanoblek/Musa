<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Seguro - MUSA Fashion</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary-color: #00b4d8;
            --secondary-color: #0077b6;
            --success-color: #00c851;
            --error-color: #ff3547;
            --warning-color: #ffbb33;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== PROGRESS BAR STYLES ===== */
        .checkout-progress {
            background: white;
            padding: 25px 20px 45px 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            max-width: 600px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .progress-line {
            position: absolute;
            top: 20px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: #e0e0e0;
            z-index: 1;
            border-radius: 2px;
        }
        
        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #667eea);
            transition: width 0.5s ease;
            border-radius: 2px;
        }
        
        .progress-step {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .progress-step.completed {
            background: #28a745;
            border-color: #28a745;
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .progress-step.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: scale(1.15);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .step-label {
            position: absolute;
            top: 65px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            color: #333;
            left: 50%;
            transform: translateX(-50%);
            min-width: 80px;
        }
        
        .progress-step.completed .step-label {
            color: #28a745;
        }
        
        .progress-step.active .step-label {
            color: #667eea;
            font-weight: 700;
        }

        .payment-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .payment-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            max-width: 1000px;
            width: 100%;
            transition: var(--transition);
        }

        .payment-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .payment-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .payment-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .brand-logo {
            position: relative;
            z-index: 2;
            margin-bottom: 15px;
        }

        .brand-logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .brand-logo p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0;
        }

        .security-badges {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 0;
            flex-wrap: wrap;
        }

        .security-badge {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .security-badge i {
            font-size: 0.8rem;
        }

        .security-badge:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Responsive para m√≥vil - Header m√°s compacto */
        @media (max-width: 768px) {
            .payment-header {
                padding: 15px 10px;
            }
            
            .brand-logo h1 {
                font-size: 1.4rem;
                margin-bottom: 3px;
            }
            
            .brand-logo p {
                font-size: 0.8rem;
            }
            
            .brand-logo {
                margin-bottom: 10px;
            }
            
            .security-badges {
                gap: 6px;
                justify-content: space-around;
            }
            
            .security-badge {
                padding: 4px 8px;
                font-size: 0.7rem;
                flex: 1;
                max-width: 90px;
                justify-content: center;
            }
            
            .security-badge span {
                display: none;
            }
            
            .security-badge i {
                font-size: 0.9rem;
            }
        }

        /* Para m√≥viles muy peque√±os */
        @media (max-width: 480px) {
            .payment-header {
                padding: 12px 8px;
            }
            
            .brand-logo h1 {
                font-size: 1.2rem;
            }
            
            .security-badges {
                gap: 4px;
            }
            
            .security-badge {
                padding: 3px 6px;
                max-width: 80px;
            }
        }

        .payment-body {
            padding: 40px;
        }

        .order-summary {
            background: var(--light-color);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* ===== ORDER SUMMARY STYLES ===== */
        .order-summary h3 {
            color: var(--dark-color);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .order-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .payment-methods {
            margin-bottom: 30px;
        }

        .payment-methods h3 {
            color: var(--dark-color);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .method-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .method-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 15px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background: white;
            cursor: pointer !important;
            transition: var(--transition);
            text-align: center;
            position: relative;
            overflow: hidden;
            pointer-events: auto !important;
            z-index: 100;
            user-select: none;
        }

        .method-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition);
        }

        .method-tab:hover::before {
            left: 100%;
        }

        .method-tab.active {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 180, 216, 0.3);
        }

        .method-tab i {
            font-size: 1.2rem;
            margin-bottom: 6px;
            display: block;
        }

        .method-tab .payment-icon {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 6px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .method-tab span {
            font-size: 0.8rem;
            font-weight: 500;
            line-height: 1.2;
        }

        /* Responsive para m√≥vil - Tabs m√°s compactos */
        @media (max-width: 768px) {
            .method-tabs {
                gap: 6px;
                margin-bottom: 15px;
                flex-wrap: wrap;
            }
            
            .method-tab {
                flex: 1 1 48%;
                min-width: 100px;
                padding: 8px 10px;
                border-radius: 8px;
            }
            
            .method-tab i {
                font-size: 1rem;
                margin-bottom: 4px;
            }
            
            .method-tab .payment-icon {
                width: 40px;
                height: 40px;
                margin-bottom: 4px;
            }
            
            .method-tab span {
                font-size: 0.7rem;
                line-height: 1.1;
            }
            
            .method-tab.active {
                transform: none;
                box-shadow: 0 3px 10px rgba(0, 180, 216, 0.2);
            }
        }

        /* Para m√≥viles muy peque√±os */
        @media (max-width: 480px) {
            .method-tabs {
                gap: 4px;
                margin-bottom: 12px;
            }
            
            .method-tab {
                padding: 6px 8px;
                min-width: 80px;
            }
            
            .method-tab i {
                font-size: 0.9rem;
                margin-bottom: 2px;
            }
            
            .method-tab .payment-icon {
                width: 30px;
                height: 30px;
                margin-bottom: 2px;
            }
            
            .method-tab span {
                font-size: 0.6rem;
                display: block;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }

        /* Orientaci√≥n portrait en m√≥vil - Layout en 2 columnas */
        @media (max-width: 600px) and (orientation: portrait) {
            .method-tabs {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }
            
            .method-tab {
                flex: none;
                min-width: auto;
            }
        }

        .card-form {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }

        .card-form:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .form-info {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .form-info p {
            margin: 0;
            font-size: 14px;
            color: var(--dark-color);
        }

        /* PSE Styles */
        .pse-form {
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }

        .pse-form:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .pse-benefits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .benefit-item i {
            font-size: 16px;
        }

        .pse-info-box {
            background: linear-gradient(135deg, #e8f4f8, #f0f8ff);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #004aad;
        }

        .pse-info-box h6 {
            color: #004aad;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .pse-info-box ol {
            margin: 0;
            padding-left: 20px;
        }

        /* Bank Selector Styles */
        .bank-selector-container {
            margin-top: 15px;
        }

        .bank-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: #f8f9fa;
        }

        .bank-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .bank-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #007bff;
        }

        .bank-option.selected {
            border-color: #28a745;
            background: #f8fff9;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .bank-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 5px;
            background: #28a745;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .bank-icon {
            width: 80px;
            height: 32px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            overflow: hidden;
        }

        .bank-logo {
            width: 100%;
            height: 100%;
        }

        .bank-name {
            font-size: 11px;
            font-weight: 500;
            color: #333;
            line-height: 1.2;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .selected-bank-info {
            margin-top: 15px;
        }

        .selected-bank-info .alert {
            margin-bottom: 0;
            padding: 12px 15px;
            border-radius: 8px;
        }

        /* PSE Section Styles */
        .pse-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .pse-section:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .pse-info-banner {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
        }

        .pse-info-content {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1565c0;
            font-size: 14px;
            font-weight: 500;
        }

        .pse-info-content i {
            color: #1976d2;
            font-size: 16px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e8f4f8;
        }

        .section-title i {
            font-size: 20px;
            color: #004aad;
            background: linear-gradient(135deg, #e8f4f8, #f0f8ff);
            padding: 8px;
            border-radius: 8px;
        }

        /* Form enhancements */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
        }

        /* Responsive adjustments for bank selector */
        @media (max-width: 768px) {
            .bank-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
                padding: 12px;
            }

            .bank-option {
                padding: 8px 6px;
            }

            .bank-icon {
                width: 70px;
                height: 28px;
            }

            .bank-name {
                font-size: 10px;
            }

            .pse-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .section-title {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .bank-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 6px;
                padding: 10px;
            }

            .bank-option {
                padding: 6px 4px;
            }

            .bank-icon {
                width: 60px;
                height: 24px;
            }

            .bank-name {
                font-size: 9px;
            }

            .pse-section {
                padding: 12px;
            }

            .section-title {
                font-size: 14px;
                gap: 8px;
            }

            .section-title i {
                font-size: 16px;
                padding: 6px;
            }
        }

        .pse-info-box li {
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .form-info i {
            color: var(--primary-color);
            margin-right: 8px;
        }

        /* Estilos para Nequi/Daviplata */
        .nequi-daviplata-form {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
        }

        .payment-info-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid #dee2e6;
        }

        .nequi-info {
            text-align: center;
        }

        .nequi-logo {
            width: 80px;
            height: auto;
            margin-bottom: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .phone-number {
            background: #007bff;
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1.5rem 0;
            position: relative;
            overflow: hidden;
        }

        .phone-number::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .number-display {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            margin-top: 0.5rem;
            user-select: all;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .number-display:hover {
            transform: scale(1.05);
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
        }

        .payment-instructions {
            text-align: left;
            margin-top: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .payment-instructions h5 {
            color: #28a745;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .payment-instructions ol {
            padding-left: 1.5rem;
        }

        .payment-instructions li {
            margin-bottom: 0.8rem;
            line-height: 1.6;
            font-size: 1.05rem;
        }

        .transfer-amount {
            font-size: 1.5rem !important;
            font-weight: bold !important;
            text-align: center !important;
            background: #f8f9fa !important;
            border: 2px solid #28a745 !important;
            color: #28a745 !important;
        }

        .receipt-preview {
            margin-top: 1rem;
        }

        .preview-container {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #28a745;
        }

        .receipt-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .preview-text {
            color: #28a745;
            font-weight: bold;
            margin: 0;
        }

        /* ===== MERCADOPAGO FORM STYLES ===== */
        .mercadopago-form {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .mercadopago-form.show {
            display: block;
        }

        .mercadopago-info {
            background: linear-gradient(135deg, rgba(0, 179, 240, 0.1) 0%, rgba(0, 115, 217, 0.1) 100%);
            border: 2px solid rgba(0, 179, 240, 0.3);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }

        .mp-logo-container {
            margin-bottom: 1.5rem;
        }

        .mp-logo {
            height: 40px;
            margin-bottom: 1rem;
        }

        .mercadopago-info h4 {
            color: #0073d9;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.4rem;
        }

        .mp-description {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 2rem;
            font-weight: 500;
        }

        .payment-methods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .payment-method-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(0, 179, 240, 0.2);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .payment-method-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 179, 240, 0.2);
            border-color: rgba(0, 179, 240, 0.4);
        }

        .payment-method-item i {
            font-size: 1.5rem;
            color: #0073d9;
            min-width: 24px;
        }

        .redirect-info {
            margin-top: 2rem;
        }

        .info-box {
            background: rgba(0, 179, 240, 0.05);
            border: 1px solid rgba(0, 179, 240, 0.2);
            border-radius: 8px;
            padding: 1.2rem;
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
            text-align: left;
        }

        .info-box i {
            color: #0073d9;
            font-size: 1.2rem;
            margin-top: 0.2rem;
            min-width: 20px;
        }

        .info-box p {
            margin: 0;
            color: #555;
            line-height: 1.5;
        }

        /* Responsive para MercadoPago */
        @media (max-width: 768px) {
            .mercadopago-form {
                padding: 1.5rem 1rem;
            }
            
            .mercadopago-info {
                padding: 1.5rem;
            }
            
            .mercadopago-info h4 {
                font-size: 1.2rem;
            }
            
            .mp-description {
                font-size: 1rem;
            }
            
            .payment-methods-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
                margin: 1.5rem 0;
            }
            
            .payment-method-item {
                padding: 0.8rem;
                font-size: 0.9rem;
            }
            
            .payment-method-item i {
                font-size: 1.3rem;
            }
        }

        /* Bot√≥n de pago dentro del formulario MercadoPago */
        .mercadopago-form .pay-button {
            width: 100%;
            margin-top: 2rem;
            background: linear-gradient(135deg, #00B3FF, #0073D9);
            border: none;
            border-radius: 12px;
            padding: 1.2rem 2rem;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .mercadopago-form .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 179, 240, 0.4);
        }

        .mercadopago-form .pay-button:active {
            transform: translateY(0);
        }

        .mercadopago-form .pay-button.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .mercadopago-form .pay-button i {
            font-size: 1.2rem;
        }

        @media (max-width: 480px) {
            .mercadopago-form {
                padding: 1rem 0.5rem;
            }
            
            .mercadopago-info {
                padding: 1.2rem;
            }
            
            .mercadopago-info h4 {
                font-size: 1.1rem;
                flex-direction: column;
                gap: 0.3rem;
            }
            
            .mp-description {
                font-size: 0.95rem;
                margin-bottom: 1.5rem;
            }
            
            .payment-method-item {
                padding: 0.7rem;
                font-size: 0.85rem;
            }
            
            .info-box {
                padding: 1rem;
                flex-direction: column;
                text-align: center;
            }
            
            .info-box i {
                margin-top: 0;
            }
        }

        /* Estilos para WhatsApp - Bot√≥n Profesional y Llamativo */
        .whatsapp-form {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .whatsapp-form.show {
            display: block;
        }

        .whatsapp-button {
            position: relative;
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            border: none;
            padding: 1.5rem 2.5rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            overflow: hidden;
            z-index: 1;
        }

        .whatsapp-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
            z-index: -1;
        }

        .whatsapp-button:hover::before {
            left: 100%;
        }

        .whatsapp-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 40px rgba(37, 211, 102, 0.6);
            background: linear-gradient(135deg, #128c7e 0%, #25d366 100%);
        }

        .whatsapp-button:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        }

        .whatsapp-button i {
            font-size: 1.5rem;
            animation: pulse 2s infinite;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        .whatsapp-button::after {
            content: 'üí¨';
            position: absolute;
            right: 20px;
            font-size: 1.3rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        /* Efectos adicionales para llamar la atenci√≥n */
        .whatsapp-button-container {
            position: relative;
            margin: 2rem 0;
            padding-top: 30px;
        }

        .whatsapp-button-container::before {
            content: '‚¨áÔ∏è ¬°PEDIDO R√ÅPIDO POR WHATSAPP! ‚¨áÔ∏è';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            animation: glow 2s ease-in-out infinite alternate;
            white-space: nowrap;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
            border: 2px solid #fff;
        }

        @keyframes glow {
            from { 
                box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
                transform: translateX(-50%) scale(1);
            }
            to { 
                box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
                transform: translateX(-50%) scale(1.05);
            }
        }

        /* Efecto de resplandor adicional alrededor del bot√≥n */
        .whatsapp-button-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, rgba(37, 211, 102, 0.2) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            border-radius: 50px;
            animation: breathe 3s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes breathe {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.3;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 0.6;
            }
        }

        .whatsapp-info {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(18, 140, 126, 0.1) 100%);
            border: 2px solid rgba(37, 211, 102, 0.3);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }

        .whatsapp-info h4 {
            color: #128c7e;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.3rem;
        }

        .whatsapp-info ul {
            text-align: left;
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        .whatsapp-info li {
            margin: 0.8rem 0;
            color: var(--dark-color);
            font-weight: 500;
        }

        .whatsapp-preview {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #25d366;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .whatsapp-preview h5 {
            color: #128c7e;
            margin-bottom: 1rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .whatsapp-preview .message-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            max-height: 120px;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-line;
        }

        .payment-info-section {
            background: linear-gradient(135deg, #00d4aa, #1dd1a1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            color: white;
            text-align: center;
        }

        .nequi-logo {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 15px;
            background: white;
            border-radius: 12px;
            padding: 8px;
        }

        .payment-info-section h4 {
            margin-bottom: 20px;
            font-weight: 600;
        }

        .number-display {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            font-size: 1.8rem;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 10px 0;
            border: 2px dashed rgba(255, 255, 255, 0.5);
        }

        .payment-instructions {
            text-align: left;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .payment-instructions h5 {
            margin-bottom: 15px;
            color: #fff;
        }

        .payment-instructions ol {
            margin: 0;
            padding-left: 20px;
        }

        .payment-instructions li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .transfer-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--success-color);
            background: #f8f9fa;
        }

        .receipt-preview {
            margin-top: 15px;
        }

        .message-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
            line-height: 1.3;
            white-space: pre-line;
        }

        .whatsapp-contact-info {
            background: rgba(37, 211, 102, 0.05);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-top: 1rem;
        }

        .contact-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.3rem 0;
            font-size: 0.9rem;
        }

        .cart-summary {
            background: rgba(37, 211, 102, 0.08);
            border: 1px solid rgba(37, 211, 102, 0.2);
            border-radius: 8px;
            padding: 0.8rem;
            margin: 0.8rem 0;
        }
        
        .cart-summary .alert {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(40, 167, 69, 0.1));
            border: 1px solid rgba(40, 167, 69, 0.3);
            border-radius: 6px;
            padding: 0.6rem;
            margin: 0;
            color: #155724;
            font-weight: 500;
            text-align: center;
        }
        
        .whatsapp-info {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.1) 0%, rgba(18, 140, 126, 0.1) 100%);
            border: 2px solid rgba(37, 211, 102, 0.3);
            border-radius: var(--border-radius);
            padding: 1.2rem;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }
        
        .whatsapp-info h4 {
            color: #128c7e;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.3rem;
        }

        .whatsapp-button.disabled {
            background: #6c757d !important;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none !important;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3) !important;
        }

        .whatsapp-button.disabled:hover {
            transform: none !important;
            background: #6c757d !important;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3) !important;
        }

        .whatsapp-button.disabled i {
            animation: none !important;
        }

        .whatsapp-button.disabled::after {
            content: '‚ùå';
            animation: none !important;
        }

        .whatsapp-button.disabled::before {
            display: none !important;
        }

        .preview-container {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #28a745;
        }

        .receipt-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .preview-text {
            margin-top: 10px;
            color: #28a745;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.1);
            transform: translateY(-1px);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .card-logos {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .card-logo {
            width: 45px;
            height: 28px;
            background: white;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .card-logo:hover {
            transform: scale(1.05);
            opacity: 1;
        }

        .card-logo.active {
            opacity: 1;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 180, 216, 0.2);
        }

        .pay-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--success-color), #00a943);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 200, 81, 0.3);
        }

        .pay-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition);
        }

        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 200, 81, 0.4);
        }

        .pay-button:hover::before {
            left: 100%;
        }

        .pay-button:active {
            transform: translateY(0);
        }

        .pay-button.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        .pay-button.loading .loading-spinner {
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .mercadopago-branding {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: var(--border-radius);
        }

        .mercadopago-logo {
            height: 30px;
            margin-bottom: 10px;
        }

        .trust-indicators {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .trust-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: #666;
        }

        .trust-item i {
            color: var(--success-color);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: none;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(0, 200, 81, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .alert-error {
            background: rgba(255, 53, 71, 0.1);
            color: var(--error-color);
            border-left: 4px solid var(--error-color);
        }

        .alert-warning {
            background: rgba(255, 187, 51, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .cost-item i {
            color: var(--primary-color);
            width: 16px;
        }

        .cost-value {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .delivery-time {
            color: var(--success-color);
            font-weight: 500;
        }

        .estimated-delivery {
            background: rgba(40, 167, 69, 0.1);
            border-radius: 8px;
            padding: 8px 12px !important;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .payment-container {
                padding: 10px;
            }
            
            .payment-body {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .method-tabs {
                flex-direction: column;
            }
            
            .method-tab {
                min-width: auto;
            }

            .shipping-section {
                padding: 20px 15px;
            }
            
            .trust-indicators {
                flex-direction: column;
                gap: 10px;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ===== PSE MODAL STYLES SIMPLIFICADOS ===== */
        .pse-modal-container {
            max-width: 95vw !important;
            max-height: 95vh !important;
            border-radius: 12px !important;
            overflow: hidden !important;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15) !important;
        }

        .pse-container {
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            min-height: 500px;
        }

        .pse-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 500px;
            background: white;
            color: #004aad;
            padding: 40px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
        }

        .pse-loading .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #e3f2fd;
            border-top: 5px solid #004aad;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .pse-loading p {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
            color: #475569;
            text-align: center;
        }

        #pseFrame {
            width: 100% !important;
            height: 600px !important;
            border: none !important;
            border-radius: 0 !important;
            background: white;
            display: block;
            margin: 0;
        }

        /* ===== RESPONSIVE MOBILE OPTIMIZADO ===== */
        @media (max-width: 768px) {
            .pse-modal-container {
                max-width: 100vw !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
            }

            .pse-container {
                min-height: 100vh;
                border-radius: 0;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .pse-loading {
                height: 100vh;
                padding: 20px;
            }

            .pse-loading .spinner {
                width: 50px;
                height: 50px;
                border-width: 4px;
            }

            .pse-loading p {
                font-size: 16px;
            }

            #pseFrame {
                height: 100vh !important;
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .pse-modal-container {
                max-width: 100vw !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }

            .pse-container {
                border-radius: 0;
                min-height: 100vh;
                height: 100vh;
            }

            .pse-loading {
                height: 100vh;
                padding: 15px;
            }

            .pse-loading .spinner {
                width: 45px;
                height: 45px;
                border-width: 3px;
            }

            .pse-loading p {
                font-size: 14px;
                max-width: 250px;
                margin: 0 auto;
            }

            #pseFrame {
                height: 100vh !important;
                width: 100vw !important;
            }
        }

        @media (max-width: 360px) {
            .pse-loading p {
                font-size: 13px;
                max-width: 200px;
            }

            .pse-loading .spinner {
                width: 40px;
                height: 40px;
                border-width: 3px;
            }
        }

        /* ===== ORIENTACI√ìN LANDSCAPE EN M√ìVILES ===== */
        @media (max-width: 768px) and (orientation: landscape) {
            .pse-modal-container {
                max-height: 100vh !important;
            }
            
            .pse-container {
                height: 100vh;
            }
            
            #pseFrame {
                height: 100vh !important;
            }
        }

        /* ===== FIXES PARA SAFARI iOS ===== */
        @media (max-width: 768px) {
            .pse-modal-container {
                -webkit-transform: translate3d(0,0,0) !important;
                transform: translate3d(0,0,0) !important;
            }
            
            #pseFrame {
                -webkit-overflow-scrolling: touch;
                overflow: auto;
            }
        }

        /* ===== MODAL PSE SIMPLIFICADO - SOLO ESENCIALES ===== */
        
        /* SweetAlert2 Custom Overrides */
        .swal2-popup.pse-modal-container {
            padding: 0 !important;
            background: white !important;
            border-radius: 12px !important;
        }

        .swal2-header {
            display: none !important;
        }

        .swal2-close {
            position: absolute !important;
            top: 12px !important;
            right: 12px !important;
            z-index: 1000 !important;
            background: rgba(0, 0, 0, 0.1) !important;
            border-radius: 50% !important;
            width: 32px !important;
            height: 32px !important;
            font-size: 16px !important;
            color: #64748b !important;
            border: none !important;
            transition: all 0.3s ease !important;
        }

        .swal2-close:hover {
            background: rgba(0, 0, 0, 0.2) !important;
            color: #dc2626 !important;
        }

        /* Animaci√≥n de spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== MOBILE RESPONSIVE ESPEC√çFICO ===== */
        @media (max-width: 768px) {
            .swal2-container {
                padding: 0 !important;
            }
            
            .swal2-popup.pse-modal-container {
                width: 100vw !important;
                height: 100vh !important;
                max-width: 100vw !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
            }

            .swal2-close {
                top: 15px !important;
                right: 15px !important;
                width: 40px !important;
                height: 40px !important;
                font-size: 18px !important;
                background: rgba(255, 255, 255, 0.9) !important;
                backdrop-filter: blur(10px) !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }

            .swal2-close:hover {
                background: rgba(255, 255, 255, 1) !important;
                transform: scale(1.1) !important;
            }
        }

        @media (max-width: 480px) {
            .swal2-popup.pse-modal-container {
                border-radius: 0 !important;
            }

            .swal2-close {
                top: 10px !important;
                right: 10px !important;
                width: 36px !important;
                height: 36px !important;
                font-size: 16px !important;
            }
        }

        @media (max-width: 360px) {
            .swal2-close {
                top: 8px !important;
                right: 8px !important;
                width: 32px !important;
                height: 32px !important;
                font-size: 14px !important;
            }
        }

        /* ===== FIX PARA VIEWPORT EN M√ìVILES ===== */
        @media (max-width: 768px) {
            .swal2-container {
                height: 100vh !important;
                overflow: hidden !important;
            }
        }

        /* ===== SOPORTE PARA NOTCH EN IPHONE ===== */
        @media (max-width: 768px) {
            .swal2-popup.pse-modal-container {
                padding-top: env(safe-area-inset-top) !important;
                padding-bottom: env(safe-area-inset-bottom) !important;
                padding-left: env(safe-area-inset-left) !important;
                padding-right: env(safe-area-inset-right) !important;
            }

            .swal2-close {
                top: calc(10px + env(safe-area-inset-top)) !important;
                right: calc(10px + env(safe-area-inset-right)) !important;
                background: rgba(0, 0, 0, 0.8) !important;
                color: white !important;
                border-radius: 50% !important;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
                z-index: 10001 !important;
            }

            .swal2-close:hover {
                background: rgba(220, 53, 69, 0.9) !important;
                transform: scale(1.1);
                transition: all 0.2s ease;
            }
        }

        /* ===== MEJORAS ESPEC√çFICAS PARA IFRAME PSE ===== */
        @media (max-width: 768px) {
            #pseFrame {
                width: 100vw !important;
                height: 100vh !important;
                border: none !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                object-fit: cover;
            }

            /* Pantalla de carga optimizada para m√≥vil */
            .pse-loading {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: 10000 !important;
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            }
            
            .pse-loading .loading-text {
                color: white !important;
                font-size: 18px !important;
                margin-bottom: 20px !important;
                text-align: center !important;
                padding: 0 20px !important;
                font-weight: 600;
            }
            
            .pse-loading .spinner-border {
                width: 3rem !important;
                height: 3rem !important;
                border-width: 4px !important;
                border-color: rgba(255, 255, 255, 0.3) !important;
                border-top-color: white !important;
                animation: spin 1s linear infinite;
            }
        }

        /* ===== SOPORTE PARA ORIENTACI√ìN LANDSCAPE ===== */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .swal2-close {
                top: calc(5px + env(safe-area-inset-top)) !important;
                right: calc(5px + env(safe-area-inset-right)) !important;
                width: 35px !important;
                height: 35px !important;
                font-size: 16px !important;
            }

            .pse-loading .loading-text {
                font-size: 16px !important;
                margin-bottom: 15px !important;
            }
            
            .pse-loading .spinner-border {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }
        }

        /* ===== SOPORTE ESPEC√çFICO PARA iOS SAFARI ===== */
        @supports (-webkit-touch-callout: none) {
            @media screen and (max-width: 768px) {
                .swal2-popup.pse-modal-container {
                    height: 100vh !important;
                    height: -webkit-fill-available !important;
                    min-height: 100vh !important;
                    min-height: -webkit-fill-available !important;
                }
                
                #pseFrame {
                    height: 100vh !important;
                    height: -webkit-fill-available !important;
                    min-height: 100vh !important;
                    min-height: -webkit-fill-available !important;
                }
                
                .pse-loading {
                    height: 100vh !important;
                    height: -webkit-fill-available !important;
                    min-height: 100vh !important;
                    min-height: -webkit-fill-available !important;
                }
            }
        }

        /* ===== ANIMACI√ìN SPINNER PERSONALIZADA ===== */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== PROGRESS BAR RESPONSIVE ===== */
        @media (max-width: 768px) {
            .checkout-progress {
                padding: 20px 10px 45px 10px;
                margin-bottom: 20px;
            }
            
            .progress-steps {
                padding: 0 15px;
                max-width: 100%;
            }
            
            .progress-line {
                left: 40px;
                right: 40px;
            }
            
            .progress-step {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .step-label {
                font-size: 10px;
                top: 58px;
                min-width: 70px;
            }
        }
        
        @media (max-width: 480px) {
            .checkout-progress {
                padding: 15px 5px 40px 5px;
            }
            
            .progress-steps {
                padding: 0 10px;
            }
            
            .progress-line {
                left: 35px;
                right: 35px;
            }
            
            .progress-step {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            
            .step-label {
                font-size: 9px;
                top: 52px;
                min-width: 60px;
            }
        }

        /* ===== WHATSAPP RESPONSIVE STYLES ===== */
        
        /* Tablet y pantallas medianas */
        @media (max-width: 768px) {
            .whatsapp-form {
                padding: 1.5rem 1rem;
                }
            
            .whatsapp-info {
                padding: 1.2rem;
                margin: 0.8rem 0;
            }
            
            .whatsapp-info h4 {
                font-size: 1.2rem;
                margin-bottom: 0.8rem;
            }
            
            .cart-summary {
                margin: 0.8rem 0;
                padding: 0.8rem;
            }
            
            .cart-summary .alert {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            
            .whatsapp-preview {
                padding: 1.2rem;
                margin: 1.2rem 0;
            }
            
            .whatsapp-preview .message-preview {
                max-height: 100px;
                font-size: 0.8rem;
                padding: 0.8rem;
            }
            
            .whatsapp-button {
                padding: 1.2rem 2rem;
                font-size: 1.1rem;
                margin: 1.5rem auto;
                max-width: 350px;
            }
            
            .whatsapp-button i {
                font-size: 1.3rem;
            }
            
            .whatsapp-button-container {
                margin: 1.5rem 0;
                padding-top: 25px;
            }
            
            .whatsapp-button-container::before {
                font-size: 0.75rem;
                padding: 4px 12px;
                top: -20px;
            }
            
            .whatsapp-contact-info {
                padding: 0.8rem;
                margin-top: 0.8rem;
            }
            
            .contact-detail {
                font-size: 0.85rem;
                margin: 0.25rem 0;
            }
        }
        
        /* M√≥viles */
        @media (max-width: 480px) {
            .whatsapp-form {
                padding: 1rem 0.5rem;
            }
            
            .whatsapp-info {
                padding: 1rem;
                margin: 0.6rem 0;
                border-radius: 8px;
            }
            
            .whatsapp-info h4 {
                font-size: 1.1rem;
                margin-bottom: 0.6rem;
                flex-direction: row;
                gap: 0.3rem;
                text-align: center;
            }
            
            .cart-summary {
                margin: 0.6rem 0;
                padding: 0.6rem;
            }
            
            .cart-summary .alert {
                padding: 0.6rem;
                font-size: 0.9rem;
                border-radius: 6px;
            }
            
            .whatsapp-preview {
                padding: 1rem;
                margin: 1rem 0;
                border-radius: 8px;
            }
            
            .whatsapp-preview h5 {
                font-size: 0.95rem;
                margin-bottom: 0.8rem;
            }
            
            .whatsapp-preview .message-preview {
                max-height: 80px;
                font-size: 0.75rem;
                padding: 0.6rem;
                border-radius: 6px;
                line-height: 1.3;
            }
            
            .whatsapp-preview small {
                font-size: 0.75rem;
                margin-top: 0.5rem;
                display: block;
            }
            
            .whatsapp-button {
                padding: 1rem 1.5rem;
                font-size: 1rem;
                margin: 1.2rem auto;
                max-width: 90%;
                border-radius: 30px;
                gap: 0.6rem;
            }
            
            .whatsapp-button i {
                font-size: 1.2rem;
            }
            
            .whatsapp-button::after {
                right: 15px;
                font-size: 1.1rem;
            }
            
            .whatsapp-button-container {
                margin: 1.2rem 0;
                padding-top: 20px;
            }
            
            .whatsapp-button-container::before {
                content: '‚¨áÔ∏è ¬°PEDIDO R√ÅPIDO! ‚¨áÔ∏è';
                font-size: 0.7rem;
                padding: 3px 10px;
                top: -15px;
                border-radius: 15px;
            }
            
            .whatsapp-contact-info {
                padding: 0.8rem;
                margin-top: 1rem;
                border-radius: 8px;
            }
            
            .contact-detail {
                font-size: 0.8rem;
                margin: 0.4rem 0;
                align-items: flex-start;
            }
            
            .contact-detail i {
                margin-top: 2px;
                min-width: 16px;
            }
        }
        
        /* M√≥viles peque√±os */
        @media (max-width: 360px) {
            .whatsapp-form {
                padding: 0.8rem 0.3rem;
            }
            
            .whatsapp-info {
                padding: 0.8rem;
            }
            
            .whatsapp-info h4 {
                font-size: 1rem;
            }
            
            .cart-summary .alert {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .whatsapp-preview {
                padding: 0.8rem;
            }
            
            .whatsapp-preview .message-preview {
                max-height: 70px;
                font-size: 0.7rem;
                padding: 0.5rem;
            }
            
            .whatsapp-button {
                padding: 0.9rem 1.2rem;
                font-size: 0.95rem;
                max-width: 95%;
            }
            
            .whatsapp-button i {
                font-size: 1.1rem;
            }
            
            .whatsapp-button-container::before {
                font-size: 0.65rem;
                padding: 2px 8px;
            }
            
            .contact-detail {
                font-size: 0.75rem;
            }
        }
        
        /* Landscape en m√≥viles */
        @media (max-width: 768px) and (orientation: landscape) {
            .whatsapp-form {
                padding: 1rem 0.8rem;
            }
            
            .whatsapp-info {
                padding: 1rem;
            }
            
            .whatsapp-preview .message-preview {
                max-height: 60px;
            }
            
            .whatsapp-button {
                padding: 0.8rem 1.5rem;
                font-size: 0.95rem;
            }
        }
        
        /* Hover effects en dispositivos t√°ctiles */
        @media (hover: none) and (pointer: coarse) {
            .whatsapp-button:hover {
                transform: none;
            }
            
            .whatsapp-button:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-card fade-in">
            <!-- Header -->
            <!-- Progress Bar -->
            <div class="checkout-progress">
                <div class="progress-steps">
                    <div class="progress-line">
                        <div class="progress-line-fill" style="width: 75%;"></div>
                    </div>
                    
                    <div class="progress-step completed">
                        <i class="fas fa-check"></i>
                        <div class="step-label">Carrito</div>
                    </div>
                    
                    <div class="progress-step completed">
                        <i class="fas fa-check"></i>
                        <div class="step-label">Env√≠o</div>
                    </div>
                    
                    <div class="progress-step active">
                        <i class="fas fa-credit-card"></i>
                        <div class="step-label">Pago</div>
                    </div>
                    
                    <div class="progress-step">
                        <i class="fas fa-check-circle"></i>
                        <div class="step-label">Confirmaci√≥n</div>
                    </div>
                </div>
            </div>

            <div class="payment-header">
                <div class="brand-logo">
                    <h1><i class="fas fa-shopping-bag"></i> Musa & Arion</h1>
                    <p>Pago Seguro y Protegido</p>
                </div>
                <div class="security-badges">
                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>SSL 256-bit</span>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-lock"></i>
                        <span>Seguro</span>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-check-circle"></i>
                        <span>Verificado</span>
                    </div>
                </div>
            </div>

            <!-- Body -->
            <div class="payment-body">
                <!-- Alert Container -->
                <div id="alertContainer"></div>

                <!-- Order Summary -->
                <div class="order-summary slide-up">
                    <h3><i class="fas fa-receipt"></i> Resumen del Pedido</h3>
                    <div id="orderItems">
                        <!-- Los items se cargar√°n din√°micamente -->
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="payment-methods slide-up">
                    <h3><i class="fas fa-credit-card"></i> M√©todo de Pago</h3>
                    
                    <div class="method-tabs">
                        <div class="method-tab active" data-method="mercadopago">
                            <i class="fas fa-credit-card" style="color: #00b3f0; font-size: 1.2rem;"></i>
                            <span>MercadoPago</span>
                        </div>
                        <div class="method-tab" data-method="nequi_daviplata">
                            <img src="images/Pagos/Nequi.png" alt="Nequi" class="payment-icon">
                            <span>Nequi y Daviplata</span>
                        </div>
                        <div class="method-tab" data-method="whatsapp">
                            <i class="fab fa-whatsapp" style="color: #25d366; font-size: 1.2rem;"></i>
                            <span>WhatsApp</span>
                        </div>
                    </div>

                    <!-- MercadoPago Form -->
                    <div id="mercadopagoForm" class="mercadopago-form slide-up">
                        <div class="mercadopago-info">
                            <div class="mp-logo-container">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMTYwIDQwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNMjAuNSA3LjVMMTUgMTJMMjAuNSAxNi41VjIyLjVMMTAgMTJMMjAuNSAxLjVWNy41WiIgZmlsbD0iIzAwQjNGRiIvPgo8cGF0aCBkPSJNMzAgN0g0MFYyM0gzMFY3WiIgZmlsbD0iIzAwNzNEOSIvPgo8dGV4dCB4PSI1MCIgeT0iMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiMwMDczRDkiPk1lcmNhZG9QYWdvPC90ZXh0Pgo8L3N2Zz4=" alt="MercadoPago" class="mp-logo">
                            </div>
                            
                            <h4><i class="fas fa-shield-alt"></i> Pago Seguro con MercadoPago</h4>
                            <p class="mp-description">Paga de forma segura con tarjetas de d√©bito, cr√©dito o PSE</p>
                            
                            <div class="payment-methods-grid">
                                <div class="payment-method-item">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Tarjetas de D√©bito y Cr√©dito</span>
                                </div>
                                <div class="payment-method-item">
                                    <i class="fas fa-university"></i>
                                    <span>PSE (D√©bito desde tu banco)</span>
                                </div>
                                <div class="payment-method-item">
                                    <i class="fas fa-mobile-alt"></i>
                                    <span>Cuotas sin inter√©s</span>
                                </div>
                                <div class="payment-method-item">
                                    <i class="fas fa-lock"></i>
                                    <span>Protecci√≥n al comprador</span>
                                </div>
                            </div>
                            
                            <div class="redirect-info">
                                <div class="info-box">
                                    <i class="fas fa-info-circle"></i>
                                    <p>Al hacer click en "Pagar con MercadoPago" ser√°s redirigido a la plataforma segura de MercadoPago donde podr√°s completar tu pago.</p>
                                </div>
                            </div>
                            
                            <!-- Pay Button -->
                            <button id="payButton" class="pay-button slide-up">
                                <div class="loading-spinner"></div>
                                <i class="fas fa-lock"></i>
                                Pagar con MercadoPago
                            </button>
                        </div>
                    </div>

                    <!-- Nequi/Daviplata Form -->
                    <div id="nequiForm" class="nequi-form slide-up" style="display: none;">
                        <!-- El contenido se generar√° din√°micamente -->
                    </div>

                    <!-- WhatsApp Form -->
                    <div id="whatsappForm" class="whatsapp-form slide-up" style="display: none;">
                        <!-- El contenido se generar√° din√°micamente -->
                    </div>
                </div>

                <!-- MercadoPago Branding -->
                <div class="mercadopago-branding">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMTIwIDMwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNMjAuNSA3LjVMMTUgMTJMMjAuNSAxNi41VjIyLjVMMTAgMTJMMjAuNSAxLjVWNy41WiIgZmlsbD0iIzAwQjNGRiIvPgo8cGF0aCBkPSJNMzAgN0g0MFYyM0gzMFY3WiIgZmlsbD0iIzAwNzNEOSIvPgo8dGV4dCB4PSI1MCIgeT0iMTgiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiMwMDczRDkiPk1lcmNhZG9QYWdvPC90ZXh0Pgo8L3N2Zz4=" alt="MercadoPago" class="mercadopago-logo">
                    <div class="trust-indicators">
                        <div class="trust-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Protecci√≥n al comprador</span>
                        </div>
                        <div class="trust-item">
                            <i class="fas fa-undo-alt"></i>
                            <span>Devoluci√≥n garantizada</span>
                        </div>
                        <div class="trust-item">
                            <i class="fas fa-headset"></i>
                            <span>Soporte 24/7</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // üöÄ SISTEMA DE MERCADOPAGO PREMIUM - CON MANEJO ROBUSTO DE SDK
        
        // üîÑ FUNCI√ìN PARA ESPERAR A QUE EL SDK SE CARGUE
        function waitForMercadoPago(maxAttempts = 10, interval = 1000) {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                
                const checkSDK = () => {
                    attempts++;
                    console.log(`üîç Verificando SDK MercadoPago... (Intento ${attempts}/${maxAttempts})`);
                    
                    if (typeof window.MercadoPago !== 'undefined') {
                        console.log('‚úÖ SDK MercadoPago cargado exitosamente');
                        resolve(window.MercadoPago);
                    } else if (attempts >= maxAttempts) {
                        console.error('‚ùå Timeout: SDK MercadoPago no se carg√≥ despu√©s de', maxAttempts, 'intentos');
                        reject(new Error('SDK MercadoPago no disponible'));
                    } else {
                        console.log('‚è≥ SDK a√∫n no disponible, reintentando...');
                        setTimeout(checkSDK, interval);
                    }
                };
                
                checkSDK();
            });
        }
        
        class PremiumPaymentSystem {
            constructor() {
                this.mp = null;
                this.cardForm = null;
                this.cart = [];
                this.total = 0;
                this.isProcessing = false;
                this.expressCheckout = null;
                
                this.init();
            }

            async init() {
                try {
                    console.log('üöÄ Inicializando Sistema de Pago Premium...');
                    
                    // Cargar carrito desde localStorage
                    this.loadCart();
                    
                    // Inicializar MercadoPago (sin fallar si hay error)
                    await this.initMercadoPago();
                    
                    // Renderizar orden
                    this.renderOrderSummary();
                    
                    // Configurar eventos
                    this.setupEventListeners();
                    
                    // Formatear campos
                    this.setupFieldFormatting();
                    
                    // Activar m√©todo de pago por defecto (tarjeta)
                    setTimeout(() => {
                        this.initializeDefaultPaymentMethod();
                    }, 100);
                    
                    console.log('‚úÖ Sistema de Pago Premium inicializado correctamente');
                    
                } catch (error) {
                    console.error('‚ùå Error inicializando sistema de pago:', error);
                    // No mostrar alert de error, solo continuar con funcionalidad limitada
                    console.log('üîÑ Continuando con funcionalidad limitada...');
                    
                    // Asegurar que al menos el resumen se muestre
                    try {
                        this.renderOrderSummary();
                    } catch (renderError) {
                        console.error('‚ùå Error renderizando resumen:', renderError);
                    }
                }
            }

            async initMercadoPago() {
                try {
                    console.log('üîß Inicializando MercadoPago con configuraci√≥n autom√°tica...');
                    
                    // üîç DETECCI√ìN AUTOM√ÅTICA DE ENTORNO
                    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    
                    let config;
                    if (isLocalhost) {
                        // LOCALHOST - Credenciales de TEST
                        config = {
                            success: true,
                            configured: true,
                            environment: 'test',
                            public_key: 'TEST-70da85e6-8bcb-4f2c-9c62-d8532ae88a4a',
                            domain: window.location.origin
                        };
                        console.log('üß™ Modo TEST detectado para localhost');
                    } else {
                        // HOSTING - Credenciales de PRODUCCI√ìN
                        config = {
                            success: true,
                            configured: true,
                            environment: 'production',
                            public_key: 'APP_USR-5afce1ba-5244-42d4-939e-f9979851577',
                            domain: window.location.origin
                        };
                        console.log('üè≠ Modo PRODUCCI√ìN detectado para hosting');
                    }
                    
                    try {
                        // üåç CONFIGURACI√ìN AUTOM√ÅTICA BASADA EN ENTORNO
                        console.log('üîß Aplicando configuraci√≥n autom√°tica...');
                        
                        console.log('‚úÖ Configuraci√≥n aplicada exitosamente');
                    } catch (fetchError) {
                        console.warn('‚ö†Ô∏è Error cargando configuraci√≥n desde servidor:', fetchError.message);
                        console.log('üîÑ Usando configuraci√≥n de prueba local');
                    }
                    
                    // üî¥ INICIALIZAR MERCADOPAGO CON LA CONFIGURACI√ìN DISPONIBLE
                    
                    // üéØ GUARDAR CONFIGURACI√ìN EN LA INSTANCIA
                    this.config = config;
                    
                    // ‚è≥ ESPERAR A QUE EL SDK SE CARGUE COMPLETAMENTE
                    try {
                        const MercadoPago = await waitForMercadoPago();
                        
                        this.mp = new MercadoPago(config.public_key, {
                            locale: 'es-CO'
                        });
                        
                        console.log(`‚úÖ MercadoPago ${config.environment.toUpperCase()} inicializado correctamente`);
                        console.log(`üìç Dominio: ${config.domain}`);
                        console.log(`üîë Public Key: ${config.public_key ? config.public_key.substring(0, 20) + '...' : 'No disponible'}`);
                        console.log(`‚öôÔ∏è Configurado: ${config.configured ? 'S√ç' : 'NO'}`);
                        
                    } catch (sdkError) {
                        console.error('‚ùå Error cargando SDK de MercadoPago:', sdkError.message);
                        console.log('‚ö†Ô∏è El sistema continuar√° con funcionalidad limitada');
                        
                        // Mostrar mensaje al usuario
                        this.showSDKError();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error inicializando MercadoPago:', error);
                    console.log('üîÑ Continuando sin sistema de pagos configurado');
                    // No lanzar el error, continuar sin MercadoPago
                }
            }

            showSDKError() {
                // Mostrar mensaje discreto en la consola y UI si es necesario
                console.warn('‚ö†Ô∏è Sistema funcionando con limitaciones - algunos m√©todos de pago pueden no estar disponibles');
                
                // Agregar badge de advertencia visual (opcional)
                const paymentHeader = document.querySelector('.payment-header');
                if (paymentHeader && !document.querySelector('.sdk-warning')) {
                    const warningBadge = document.createElement('div');
                    warningBadge.className = 'sdk-warning alert alert-warning alert-dismissible fade show mt-2';
                    warningBadge.style.fontSize = '12px';
                    warningBadge.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <small>Algunos m√©todos de pago pueden tener funcionalidad limitada</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    paymentHeader.appendChild(warningBadge);
                }
            }

            loadCart() {
                try {
                    console.log('üõí Cargando carrito desde localStorage...');
                    
                    const cartData = localStorage.getItem('carrito');
                    if (cartData) {
                        const parsedCart = JSON.parse(cartData);
                        
                        // Validar que sea un array
                        if (Array.isArray(parsedCart)) {
                            this.cart = parsedCart;
                            
                            // Normalizar datos del carrito
                            this.cart = this.cart.map(item => ({
                                ...item,
                                // Asegurar nombres consistentes
                                name: item.name || item.nombre || 'Producto sin nombre',
                                price: parseFloat(item.price || item.precio || 0),
                                quantity: parseInt(item.quantity || item.cantidad || 1),
                                color: item.color || item.color || '',
                                size: item.size || item.talla || '',
                                image: item.image || item.imagen || ''
                            }));
                            
                            this.calculateTotal();
                            console.log('‚úÖ Carrito cargado:', this.cart.length, 'productos');
                            console.log('üì¶ Productos:', this.cart.map(item => ({
                                name: item.name,
                                price: item.price,
                                quantity: item.quantity
                            })));
                            
                        } else {
                            console.warn('‚ö†Ô∏è Datos del carrito no son v√°lidos (no es array)');
                            this.cart = [];
                        }
                    } else {
                        console.warn('‚ö†Ô∏è No hay productos en el carrito');
                        console.log('üîÑ Agregando productos de prueba autom√°ticamente...');
                        
                        // Agregar productos de prueba autom√°ticamente
                        this.addTestProducts();
                        
                        // Recargar carrito despu√©s de agregar productos de prueba
                        const cartData = localStorage.getItem('carrito');
                        if (cartData) {
                            const parsedCart = JSON.parse(cartData);
                            if (Array.isArray(parsedCart)) {
                                this.cart = parsedCart.map(item => ({
                                    ...item,
                                    name: item.name || item.nombre || 'Producto sin nombre',
                                    price: parseFloat(item.price || item.precio || 0),
                                    quantity: parseInt(item.quantity || item.cantidad || 1),
                                    color: item.color || item.color || '',
                                    size: item.size || item.talla || '',
                                    image: item.image || item.imagen || ''
                                }));
                                this.calculateTotal();
                                console.log('‚úÖ Productos de prueba cargados al carrito');
                            } else {
                                this.cart = [];
                            }
                        } else {
                            this.cart = [];
                            console.error('‚ùå Error cargando productos de prueba');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error cargando carrito:', error);
                    this.cart = [];
                    this.showAlert('Error al cargar los productos del carrito', 'error');
                }
            }

            calculateSubtotal() {
                return this.cart.reduce((sum, item) => {
                    const price = parseFloat(item.precio || item.price || 0);
                    const quantity = parseInt(item.cantidad || item.quantity || 1);
                    return sum + (price * quantity);
                }, 0);
            }

            calculateTotal() {
                const subtotal = this.cart.reduce((sum, item) => {
                    const price = parseFloat(item.precio || item.price || 0);
                    const quantity = parseInt(item.cantidad || item.quantity || 1);
                    return sum + (price * quantity);
                }, 0);
                
                // Agregar env√≠o (GRATIS)
                const shipping = 0;
                this.total = subtotal + shipping;
                
                return this.total;
            }

            renderOrderSummary() {
                console.log('üìã Renderizando resumen del pedido...');
                
                const container = document.getElementById('orderItems');
                if (!container) {
                    console.error('‚ùå No se encontr√≥ el contenedor orderItems');
                    return;
                }

                if (!this.cart || this.cart.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-cart-x fs-1 text-muted"></i>
                            <h6 class="text-muted mt-3">Carrito vac√≠o</h6>
                            <p class="text-muted">No hay productos para mostrar</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                let subtotal = 0;

                console.log('üì¶ Renderizando', this.cart.length, 'productos');

                this.cart.forEach((item, index) => {
                    const price = parseFloat(item.price || 0);
                    const quantity = parseInt(item.quantity || 1);
                    const itemTotal = price * quantity;
                    subtotal += itemTotal;

                    console.log(`  - Producto ${index + 1}:`, {
                        name: item.name,
                        price: price,
                        quantity: quantity,
                        total: itemTotal
                    });

                    html += `
                        <div class="order-item border-bottom py-3">
                            <div class="d-flex align-items-start">
                                ${item.image ? `
                                    <img src="${item.image}" alt="${item.name}" 
                                         class="me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                ` : `
                                    <div class="bg-light me-3 d-flex align-items-center justify-content-center" 
                                         style="width: 60px; height: 60px; border-radius: 8px;">
                                        <i class="bi bi-image text-muted"></i>
                                    </div>
                                `}
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${item.name}</h6>
                                    <div class="small text-muted">
                                        ${item.color ? `<span class="badge bg-secondary me-1">${item.color}</span>` : ''}
                                        ${item.size ? `<span class="badge bg-secondary me-1">Talla: ${item.size}</span>` : ''}
                                        <span class="badge bg-primary">Cantidad: ${quantity}</span>
                                    </div>
                                    <div class="mt-2">
                                        <span class="fw-bold text-success">$${this.formatCurrency(itemTotal)}</span>
                                        ${quantity > 1 ? `<small class="text-muted ms-2">($${this.formatCurrency(price)} c/u)</small>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Calcular env√≠o
                const shipping = 0; // ENV√çO GRATIS
                this.total = subtotal + shipping;

                // Agregar resumen de totales
                html += `
                    <div class="order-summary mt-4">
                        <div class="order-item d-flex justify-content-between py-2">
                            <span>Subtotal (${this.cart.length} producto${this.cart.length > 1 ? 's' : ''})</span>
                            <span class="fw-bold">$${this.formatCurrency(subtotal)}</span>
                        </div>
                        <div class="order-item d-flex justify-content-between py-2">
                            <span><i class="bi bi-truck me-2"></i>Env√≠o nacional</span>
                            <span class="fw-bold">$${this.formatCurrency(shipping)}</span>
                        </div>
                        <hr>
                        <div class="order-item d-flex justify-content-between py-2">
                            <span class="fs-5 fw-bold">Total a pagar</span>
                            <span class="fs-4 fw-bold text-success">$${this.formatCurrency(this.total)}</span>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                console.log('‚úÖ Resumen renderizado correctamente');
                console.log('üí∞ Totales:', {
                    subtotal: subtotal,
                    shipping: shipping,
                    total: this.total
                });
            }

            setupEventListeners() {
                console.log('ÔøΩ Configurando listeners avanzados...');
                
                // Tabs de m√©todos de pago - con verificaci√≥n de seguridad
                const methodTabs = document.querySelectorAll('.method-tab');
                console.log('üéØ Method tabs encontradas:', methodTabs.length);
                
                methodTabs.forEach((tab, index) => {
                    console.log(`üìã Configurando tab ${index + 1}:`, tab.dataset.method);
                    tab.addEventListener('click', () => {
                        console.log('üîÑ Tab clicked:', tab.dataset.method);
                        document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const method = tab.dataset.method;
                        this.handlePaymentMethodChange(method);
                    });
                });

                // üß† SISTEMA DE AUTO-LLENADO INTELIGENTE
                this.setupIntelligentAutofill();

                // Bot√≥n de pagar - con verificaci√≥n
                const payButton = document.getElementById('payButton');
                if (payButton) {
                    console.log('üí≥ Configurando bot√≥n de pago');
                    payButton.addEventListener('click', () => {
                        this.processPayment();
                    });
                } else {
                    console.warn('‚ö†Ô∏è Bot√≥n de pago no encontrado');
                }

                // Validaci√≥n en tiempo real - con verificaci√≥n
                const cardNumber = document.getElementById('cardNumber');
                if (cardNumber) {
                    console.log('üî¢ Configurando validaci√≥n de tarjeta');
                    cardNumber.addEventListener('input', (e) => {
                        this.validateCard(e.target.value);
                    });
                } else {
                    console.warn('‚ö†Ô∏è Campo de n√∫mero de tarjeta no encontrado');
                }
                
                console.log('‚úÖ Event listeners configurados correctamente');
            }

            // üß† SISTEMA DE AUTO-LLENADO INTELIGENTE
            setupIntelligentAutofill() {
                console.log('üß† Configurando auto-llenado inteligente...');
                
                const formFields = ['email', 'fullName', 'phone', 'address'];
                
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // Auto-save mientras el usuario escribe
                        field.addEventListener('input', (e) => {
                            this.saveFieldData(fieldId, e.target.value);
                        });
                        
                        // Auto-completar al hacer focus
                        field.addEventListener('focus', (e) => {
                            this.suggestFieldValue(fieldId, e.target);
                        });
                    }
                });

                console.log('‚úÖ Auto-llenado inteligente configurado');
            }

            getSavedUserData() {
                try {
                    return JSON.parse(localStorage.getItem('userData') || '{}');
                } catch {
                    return {};
                }
            }

            saveFieldData(fieldId, value) {
                if (value.length > 2) {
                    let userData = this.getSavedUserData();
                    userData[fieldId] = value;
                    localStorage.setItem('userData', JSON.stringify(userData));
                }
            }

            suggestFieldValue(fieldId, field) {
                const userData = this.getSavedUserData();
                if (userData[fieldId] && !field.value) {
                    field.style.borderColor = '#28a745';
                    field.placeholder = `Sugerencia: ${userData[fieldId]}`;
                    
                    // Click para auto-completar
                    field.addEventListener('dblclick', () => {
                        field.value = userData[fieldId];
                        field.style.backgroundColor = '#e8f5e8';
                        setTimeout(() => {
                            field.style.backgroundColor = '';
                        }, 1000);
                    }, { once: true });
                }
            }

            setupFieldFormatting() {
                // Formatear n√∫mero de tarjeta
                document.getElementById('cardNumber').addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                });

                // Formatear fecha de vencimiento
                document.getElementById('expiryDate').addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });

                // Solo n√∫meros en CVV
                document.getElementById('cvv').addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }

            handlePaymentMethodChange(method) {
                console.log('üîÑ Cambiando m√©todo de pago a:', method);
                
                const mercadopagoForm = document.getElementById('mercadopagoForm');
                const nequiForm = document.getElementById('nequiForm');
                const whatsappForm = document.getElementById('whatsappForm');
                const shippingSection = document.querySelector('.shipping-section');
                
                console.log('üìã Elementos encontrados:', {
                    mercadopagoForm: !!mercadopagoForm,
                    nequiForm: !!nequiForm,
                    whatsappForm: !!whatsappForm,
                    shippingSection: !!shippingSection
                });
                
                // Ocultar todos los formularios primero
                if (mercadopagoForm) mercadopagoForm.style.display = 'none';
                if (nequiForm) nequiForm.style.display = 'none';
                if (whatsappForm) whatsappForm.style.display = 'none';
                
                // El bot√≥n de pago solo se muestra para MercadoPago
                const payButton = document.getElementById('payButton');
                if (payButton) {
                    payButton.style.display = 'none';
                }
                
                // Mostrar/ocultar formulario de env√≠o seg√∫n el m√©todo
                if (shippingSection) {
                    if (method === 'whatsapp') {
                        // WhatsApp maneja todo por chat, no necesita formulario de env√≠o
                        shippingSection.style.display = 'none';
                        console.log('üì¶ Env√≠o ocultado para WhatsApp (se maneja por chat)');
                    } else {
                        // Todos los dem√°s m√©todos necesitan informaci√≥n de env√≠o
                        shippingSection.style.display = 'block';
                        console.log('üì¶ Env√≠o mostrado para m√©todo:', method);
                    }
                }
                
                switch(method) {
                    case 'mercadopago':
                    case 'card':
                    case 'credit_card':
                    case 'debit_card':
                    case 'pse':
                        console.log('üí≥ MercadoPago seleccionado - Mostrando informaci√≥n');
                        if (mercadopagoForm) {
                            mercadopagoForm.style.display = 'block';
                            mercadopagoForm.classList.add('show');
                            console.log('‚úÖ Formulario MercadoPago mostrado');
                        }
                        // Mostrar el bot√≥n de pago solo para MercadoPago
                        if (payButton) {
                            payButton.style.display = 'flex';
                            console.log('‚úÖ Bot√≥n de pago MercadoPago mostrado');
                        }
                        break;
                    case 'nequi_daviplata':
                        console.log('üì± Mostrando formulario Nequi/Daviplata');
                        if (nequiForm) {
                            nequiForm.style.display = 'block';
                            this.showNequiDaviplataForm();
                        }
                        break;
                    case 'whatsapp':
                        console.log('üí¨ Mostrando formulario WhatsApp');
                        if (whatsappForm) {
                            whatsappForm.style.display = 'block';
                            this.showWhatsAppForm();
                        }
                        break;
                    default:
                        console.warn('‚ö†Ô∏è M√©todo de pago no reconocido:', method);
                }
                
                console.log('‚úÖ Cambio de m√©todo completado');
            }

            initializeDefaultPaymentMethod() {
                console.log('üéØ Inicializando m√©todo de pago por defecto...');
                
                // Verificar que las pesta√±as existan
                const methodTabs = document.querySelectorAll('.method-tab');
                console.log('üìã Pesta√±as de m√©todos encontradas:', methodTabs.length);
                
                if (methodTabs.length > 0) {
                    // Asegurar que la primera pesta√±a (tarjeta) est√© activa
                    const firstTab = methodTabs[0];
                    const method = firstTab.dataset.method || 'card';
                    
                    console.log('üîß Activando m√©todo por defecto:', method);
                    
                    // Remover clase active de todas las pesta√±as
                    methodTabs.forEach(tab => tab.classList.remove('active'));
                    
                    // Activar la primera pesta√±a
                    firstTab.classList.add('active');
                    
                    // FORZAR VISIBILIDAD DEL FORMULARIO DE TARJETA
                    const cardForm = document.getElementById('cardForm');
                    const pseForm = document.getElementById('pseForm');
                    
                    if (cardForm) {
                        cardForm.style.display = 'block';
                        cardForm.style.visibility = 'visible';
                        cardForm.style.opacity = '1';
                        console.log('üí≥ Formulario de tarjeta forzado a visible');
                    }
                    
                    if (pseForm) {
                        pseForm.style.display = 'none';
                        console.log('üè¶ Formulario PSE ocultado');
                    }
                    
                    // Mostrar el formulario correspondiente usando la funci√≥n normal
                    this.handlePaymentMethodChange(method);
                    
                    console.log('‚úÖ M√©todo de pago por defecto activado:', method);
                } else {
                    console.warn('‚ö†Ô∏è No se encontraron pesta√±as de m√©todos de pago');
                    
                    // FALLBACK: Forzar visibilidad del formulario de tarjeta sin pesta√±as
                    const cardForm = document.getElementById('cardForm');
                    if (cardForm) {
                        cardForm.style.display = 'block';
                        cardForm.style.visibility = 'visible';
                        cardForm.style.opacity = '1';
                        console.log('üí≥ Formulario de tarjeta forzado (fallback)');
                    }
                }
            }

            showNequiDaviplataForm() {
                const nequiForm = document.getElementById('nequiForm');
                nequiForm.innerHTML = `
                    <div class="nequi-daviplata-form">
                        <div class="payment-info-section">
                            <div class="nequi-info">
                                <img src="images/Pagos/Nequi.png" alt="Nequi" class="nequi-logo">
                                <h4><i class="fas fa-mobile-alt"></i> Pago con Nequi o Daviplata</h4>
                                <div class="phone-number">
                                    <p><strong>N√∫mero para transferir:</strong></p>
                                    <div class="number-display">3232212316</div>
                                </div>
                                <div class="payment-instructions">
                                    <h5><i class="fas fa-list-ol"></i> Instrucciones:</h5>
                                    <ol>
                                        <li>Abre tu app de Nequi o Daviplata</li>
                                        <li>Transfiere el monto total a: <strong>3232212316</strong></li>
                                        <li>Toma captura de pantalla del comprobante</li>
                                        <li>Sube el comprobante en el campo de abajo</li>
                                        <li>Completa la informaci√≥n de env√≠o</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="transferAmount"><i class="fas fa-dollar-sign"></i> Monto a Transferir</label>
                            <input type="text" id="transferAmount" class="form-control transfer-amount" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="receiptUpload"><i class="fas fa-camera"></i> Comprobante de Transferencia *</label>
                            <input type="file" id="receiptUpload" class="form-control" accept="image/*" required>
                            <small class="form-text text-muted">Sube una imagen del comprobante de tu transferencia</small>
                            <div id="receiptPreview" class="receipt-preview"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="senderName"><i class="fas fa-user"></i> Nombre de quien env√≠a *</label>
                            <input type="text" id="senderName" class="form-control" placeholder="Nombre completo de quien realiz√≥ la transferencia" required>
                        </div>
                    </div>
                `;
                
                // Mostrar el monto total
                const transferAmountField = document.getElementById('transferAmount');
                if (transferAmountField) {
                    transferAmountField.value = '$' + this.getTotalAmount().toLocaleString('es-CO');
                }
                
                // Configurar preview del comprobante
                this.setupReceiptPreview();
            }

            setupReceiptPreview() {
                const receiptUpload = document.getElementById('receiptUpload');
                const receiptPreview = document.getElementById('receiptPreview');
                
                if (receiptUpload && receiptPreview) {
                    receiptUpload.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                receiptPreview.innerHTML = `
                                    <div class="preview-container">
                                        <img src="${e.target.result}" alt="Comprobante" class="receipt-image">
                                        <p class="preview-text">‚úÖ Comprobante cargado correctamente</p>
                                    </div>
                                `;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }

            showWhatsAppForm() {
                const whatsappForm = document.getElementById('whatsappForm');
                const cartData = this.getCartData();
                const total = this.getTotalAmount();
                const products = cartData || [];
                
                // An√°lisis del carrito
                const totalItems = products.reduce((sum, item) => sum + item.quantity, 0);
                const productNames = products.map(p => p.name).join(', ');
                const hasMultipleProducts = products.length > 1;
                
                // Generar mensaje de WhatsApp
                const whatsappMessage = this.generateWhatsAppMessage(products, total);
                const whatsappURL = `https://wa.me/573232212316?text=${encodeURIComponent(whatsappMessage)}`;
                
                whatsappForm.innerHTML = `
                    <div class="whatsapp-form show">
                        <div class="whatsapp-info">
                            <h4><i class="fab fa-whatsapp"></i> Compra por WhatsApp</h4>
                            
                            ${products.length > 0 ? `
                                <div class="cart-summary mb-3">
                                    <div class="alert alert-info">
                                        <strong>üì¶ ${totalItems} ${totalItems === 1 ? 'art√≠culo' : 'art√≠culos'}</strong> 
                                        | <strong>üí∞ Total: $${total.toLocaleString('es-CO')}</strong>
                                    </div>
                                </div>
                            ` : `
                                <div class="alert alert-warning">
                                    <strong>‚ö†Ô∏è Carrito vac√≠o</strong><br>
                                    Agrega productos antes de continuar
                                </div>
                            `}
                        </div>
                        
                        <div class="whatsapp-preview">
                            <h5><i class="fas fa-eye"></i> Vista previa del mensaje:</h5>
                            <div class="message-preview">
                                ${whatsappMessage.substring(0, 300)}${whatsappMessage.length > 300 ? '...' : ''}
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Mensaje completo: ${whatsappMessage.length} caracteres
                            </small>
                        </div>
                        
                        <div class="whatsapp-button-container">
                            <button type="button" class="whatsapp-button ${products.length === 0 ? 'disabled' : ''}" 
                                    onclick="${products.length > 0 ? `window.open('${whatsappURL}', '_blank')` : 'alert(\"Agrega productos al carrito antes de continuar\")'}"
                                    ${products.length === 0 ? 'disabled' : ''}>
                                <i class="fab fa-whatsapp"></i>
                                ${products.length > 0 ? 'Continuar por WhatsApp' : 'Agrega productos primero'}
                            </button>
                        </div>
                        
                        <div class="whatsapp-contact-info">
                            <div class="contact-detail">
                                <i class="fab fa-whatsapp text-success"></i>
                                <span><strong>+57 323 221 2316</strong></span>
                            </div>
                            <div class="contact-detail">
                                <i class="fas fa-clock text-primary"></i>
                                <span>Lun-Vie: 8AM-6PM | S√°b: 9AM-4PM</span>
                            </div>
                            <div class="contact-detail">
                                <i class="fas fa-shield-alt text-success"></i>
                                <span>Tu informaci√≥n est√° segura</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            generateWhatsAppMessage(products, total) {
                const currentDate = new Date().toLocaleDateString('es-CO');
                const currentTime = new Date().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
                
                let message = `*Hola! Quiero realizar una compra en Musa & Arion*\n\n`;
                
                message += `Fecha: ${currentDate} ${currentTime}\n`;
                message += `Desde: Tienda Online\n\n`;
                
                message += `*PEDIDO:*\n`;
                message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                
                if (products.length === 0) {
                    message += `Sin productos seleccionados\n`;
                } else {
                    products.forEach((product, index) => {
                        message += `${index + 1}. *${product.name}*\n`;
                        message += `   $${product.price.toLocaleString('es-CO')}\n`;
                        
                        if (product.size && product.size !== 'Talla √∫nica') {
                            message += `   Talla: ${product.size}\n`;
                        }
                        
                        if (product.color && product.color !== 'Color √∫nico') {
                            message += `   Color: ${product.color}\n`;
                        }
                        
                        message += `   Cantidad: ${product.quantity}\n`;
                        
                        const subtotal = product.price * product.quantity;
                        message += `   Subtotal: $${subtotal.toLocaleString('es-CO')}\n\n`;
                    });
                }
                
                message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                message += `*TOTAL: $${total.toLocaleString('es-CO')}*\n`;
                message += `*Envio: GRATIS*\n`;
                message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n`;
                
                message += `Gracias! Te responderemos pronto`;
                
                return message;
            }

            getCartData() {
                // Obtener datos del carrito desde la variable this.cart (retornar el array directamente)
                return this.cart || [];
            }

            resetCardForm() {
                const cardForm = document.getElementById('cardForm');
                // Restaurar el formulario original de tarjeta
                cardForm.innerHTML = `
                    <div class="form-info">
                        <p class="text-muted mb-3">
                            <i class="fas fa-info-circle"></i> 
                            Acepta tarjetas de d√©bito y cr√©dito de todos los bancos
                        </p>
                    </div>
                    <form id="paymentForm">
                        <!-- Aqu√≠ ir√≠a el formulario completo de tarjeta -->
                    </form>
                `;
            }

            resetPSEForm() {
                // Limpiar formulario PSE
                const pseForm = document.getElementById('pseForm');
                if (pseForm) {
                    const form = pseForm.querySelector('#psePaymentForm');
                    if (form) form.reset();
                    
                    // Limpiar selecci√≥n de banco
                    document.querySelectorAll('.bank-option').forEach(opt => opt.classList.remove('selected'));
                    const selectedBankInfo = document.getElementById('selectedBankInfo');
                    if (selectedBankInfo) selectedBankInfo.style.display = 'none';
                    
                    // Limpiar campo oculto del banco
                    const pseBankField = document.getElementById('pseBank');
                    if (pseBankField) pseBankField.value = '';
                }
            }

            validateCard(cardNumber) {
                const cleanNumber = cardNumber.replace(/\s/g, '');
                
                // Detectar tipo de tarjeta
                if (cleanNumber.startsWith('4')) {
                    this.showCardType('visa');
                } else if (cleanNumber.startsWith('5') || cleanNumber.startsWith('2')) {
                    this.showCardType('mastercard');
                } else if (cleanNumber.startsWith('3')) {
                    this.showCardType('amex');
                } else {
                    this.showCardType(null);
                }
            }

            showCardType(type) {
                // Resetear todos los logos
                document.querySelectorAll('.card-logo').forEach(logo => {
                    logo.classList.remove('active');
                    logo.style.opacity = type ? '0.3' : '0.6';
                });
                
                if (type) {
                    const typeMap = {
                        'visa': 0,
                        'mastercard': 1,
                        'amex': 2
                    };
                    
                    const logoIndex = typeMap[type];
                    if (logoIndex !== undefined) {
                        const activeLogo = document.querySelectorAll('.card-logo')[logoIndex];
                        if (activeLogo) {
                            activeLogo.style.opacity = '1';
                            activeLogo.classList.add('active');
                        }
                    }
                }
            }

            async initMercadoPagoCardForm() {
                console.log('üöÄ Inicializando widget real de MercadoPago para tarjetas...');
                
                try {
                    // Verificar que MercadoPago est√© disponible
                    if (!this.mp) {
                        console.warn('‚ö†Ô∏è MercadoPago SDK no est√° disponible, usando formulario est√°tico');
                        return;
                    }
                    
                    // Limpiar contenedor de tarjeta y crear widget de MercadoPago
                    const cardForm = document.getElementById('cardForm');
                    if (!cardForm) {
                        console.error('‚ùå Contenedor cardForm no encontrado');
                        return;
                    }
                    
                    // Crear estructura para el widget de MercadoPago
                    cardForm.innerHTML = `
                        <div class="form-info mb-4">
                            <div class="alert alert-info">
                                <i class="fas fa-credit-card me-2"></i>
                                <strong>Pago Seguro con MercadoPago</strong>
                                <p class="mb-0 mt-2">Acepta tarjetas de d√©bito y cr√©dito de todos los bancos. Transacciones 100% seguras.</p>
                            </div>
                        </div>
                        
                        <div class="mp-card-container">
                            <!-- Widget de MercadoPago -->
                            <div id="form-checkout" class="mp-form-checkout">
                                <div id="form-checkout__cardNumber" class="form-group mb-3"></div>
                                <div id="form-checkout__expirationDate" class="form-group mb-3"></div>
                                <div id="form-checkout__securityCode" class="form-group mb-3"></div>
                                <div id="form-checkout__cardholderName" class="form-group mb-3">
                                    <input type="text" name="cardholderName" id="form-checkout__cardholderName-input" 
                                           class="form-control" placeholder="Nombre del titular" />
                                </div>
                                <div id="form-checkout__issuer" class="form-group mb-3"></div>
                                <div id="form-checkout__installments" class="form-group mb-3"></div>
                                <div id="form-checkout__identificationType" class="form-group mb-3"></div>
                                <div id="form-checkout__identificationNumber" class="form-group mb-3">
                                    <input type="text" name="identificationNumber" id="form-checkout__identificationNumber-input" 
                                           class="form-control" placeholder="N√∫mero de documento" />
                                </div>
                                <div id="form-checkout__cardholderEmail" class="form-group mb-3">
                                    <input type="email" name="cardholderEmail" id="form-checkout__cardholderEmail-input" 
                                           class="form-control" placeholder="Email" />
                                </div>
                            </div>
                        </div>
                        
                        <div class="mp-security-info mt-3">
                            <div class="d-flex align-items-center text-muted">
                                <i class="fas fa-shield-alt me-2 text-success"></i>
                                <small>Tus datos est√°n protegidos por MercadoPago</small>
                            </div>
                        </div>
                    `;
                    
                    // Crear el CardForm de MercadoPago
                    const cardFormMP = this.mp.cardForm({
                        amount: this.getTotalAmount().toString(),
                        iframe: true,
                        form: {
                            id: "form-checkout",
                            cardNumber: {
                                id: "form-checkout__cardNumber",
                                placeholder: "N√∫mero de tarjeta",
                            },
                            expirationDate: {
                                id: "form-checkout__expirationDate",
                                placeholder: "MM/YY",
                            },
                            securityCode: {
                                id: "form-checkout__securityCode",
                                placeholder: "CVV",
                            },
                            cardholderName: {
                                id: "form-checkout__cardholderName-input",
                                placeholder: "Titular de la tarjeta",
                            },
                            issuer: {
                                id: "form-checkout__issuer",
                                placeholder: "Banco emisor",
                            },
                            installments: {
                                id: "form-checkout__installments",
                                placeholder: "Cuotas",
                            },
                            identificationType: {
                                id: "form-checkout__identificationType",
                                placeholder: "Tipo de documento",
                            },
                            identificationNumber: {
                                id: "form-checkout__identificationNumber-input",
                                placeholder: "N√∫mero de documento",
                            },
                            cardholderEmail: {
                                id: "form-checkout__cardholderEmail-input",
                                placeholder: "Email",
                            },
                        },
                        callbacks: {
                            onFormMounted: error => {
                                if (error) {
                                    console.error('‚ùå Error montando formulario MP:', error);
                                } else {
                                    console.log('‚úÖ Widget MercadoPago montado correctamente');
                                }
                            },
                            onSubmit: event => {
                                event.preventDefault();
                                this.processMercadoPagoPayment(cardFormMP);
                            },
                            onFetching: (resource) => {
                                console.log("üîÑ Obteniendo recurso: ", resource);
                            }
                        },
                    });
                    
                    // Guardar referencia del cardForm
                    this.cardFormMP = cardFormMP;
                    
                    console.log('‚úÖ Widget de MercadoPago inicializado para tarjetas');
                    
                } catch (error) {
                    console.error('‚ùå Error inicializando widget MercadoPago:', error);
                    // Fallback al formulario est√°tico
                    this.resetCardForm();
                }
            }
            
            getTotalAmount() {
                return this.total || 0;
            }

            async processMercadoPagoPayment(cardForm) {
                console.log('üîÑ Procesando pago con MercadoPago...');
                
                try {
                    const {token, ...formData} = await cardForm.getCardFormData();
                    
                    if (!token) {
                        throw new Error('No se pudo generar el token de pago');
                    }
                    
                    console.log('‚úÖ Token generado:', token);
                    
                    // Procesar pago con el token
                    await this.processPaymentWithToken(token, formData);
                    
                } catch (error) {
                    console.error('‚ùå Error procesando pago MP:', error);
                    this.showAlert('Error procesando el pago: ' + error.message, 'error');
                } finally {
                    this.setLoadingState(false);
                    this.isProcessing = false;
                }
            }
            
            async processPaymentWithToken(token, formData) {
                // Aqu√≠ enviar√≠as el token al backend para procesar el pago
                console.log('üöÄ Procesando pago con token:', token);
                
                const paymentData = {
                    token: token,
                    transaction_amount: this.getTotalAmount(),
                    description: `Pedido Musa & Arion - ${this.cart.length} productos`,
                    payment_method_id: formData.paymentMethodId,
                    installments: formData.installments,
                    issuer_id: formData.issuerId,
                    payer: {
                        email: formData.cardholderEmail,
                        identification: {
                            type: formData.identificationType,
                            number: formData.identificationNumber
                        }
                    }
                };
                
                // Enviar al backend
                const response = await fetch('api/process-payment.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.showAlert('¬°Pago procesado exitosamente!', 'success');
                    // Redirigir o mostrar confirmaci√≥n
                } else {
                    throw new Error(result.message || 'Error procesando el pago');
                }
            }

            async processPayment() {
                if (this.isProcessing) return;
                
                try {
                    this.isProcessing = true;
                    this.setLoadingState(true);
                    
                    // Validar formulario
                    if (!this.validateForm()) {
                        this.setLoadingState(false);
                        this.isProcessing = false;
                        return;
                    }
                    
                    console.log('‚úÖ Formulario validado exitosamente, procediendo con el pago...');
                    console.log('üöÄ Procesando pago...');
                    
                    // üéØ MODO OPTIMIZADO: Siempre usar Checkout API (pago transparente)
                    const activeMethod = document.querySelector('.method-tab.active').dataset.method;
                    
                    if (activeMethod === 'mercadopago' || activeMethod === 'card' || activeMethod === 'credit_card' || activeMethod === 'debit_card' || activeMethod === 'pse') {
                        // Procesar con MercadoPago (redirecci√≥n directa)
                        console.log('üí≥ Procesando pago con MercadoPago...');
                        await this.processMercadoPagoPayment();
                    } else if (activeMethod === 'nequi_daviplata') {
                        // Procesar pago con comprobante de Nequi/Daviplata
                        console.log('üì± Procesando pago con Nequi/Daviplata...');
                        await this.processNequiDaviplataPayment();
                    } else if (activeMethod === 'whatsapp') {
                        // El proceso de WhatsApp se maneja directamente desde el bot√≥n
                        console.log('üì± M√©todo WhatsApp seleccionado - No requiere procesamiento adicional');
                        this.setLoadingState(false);
                        this.isProcessing = false;
                        return;
                    } else {
                        // Para otros m√©todos, usar Checkout Pro
                        console.log('üîÑ Procesando con m√©todo alternativo...');
                        await this.processWithCheckoutPro();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error procesando pago:', error);
                    this.showAlert('Error al procesar el pago. Int√©ntalo nuevamente.', 'error');
                    this.setLoadingState(false);
                    this.isProcessing = false;
                }
            }

            async processWithCheckoutPro() {
                try {
                    console.log('üí≥ Usando Checkout Pro con experiencia mejorada...');
                    
                    // Preparar datos del pago incluyendo informaci√≥n del formulario
                    const paymentData = this.prepareEnhancedPaymentData();
                    
                    // Crear preferencia en MercadoPago
                    const preference = await this.createPreference(paymentData);
                    
                    if (preference.init_point) {
                        // üî• MODO PRODUCCI√ìN: Redirigir directamente a MercadoPago
                        // Mostrar modal informativo antes de redirigir
                        const result = await Swal.fire({
                                title: 'üöÄ Redirigiendo a MercadoPago',
                                html: `
                                    <div class="text-start">
                                        <p>En un momento ser√°s redirigido a MercadoPago para completar tu pago de forma segura.</p>
                                        <div class="alert alert-info mt-3">
                                            <strong>üí° Tip:</strong> Tus datos ya est√°n pre-configurados para agilizar el proceso.
                                        </div>
                                    </div>
                                `,
                                icon: 'info',
                                showCancelButton: true,
                                confirmButtonText: 'Continuar ‚Üí',
                                cancelButtonText: 'Cancelar',
                                confirmButtonColor: '#00b4d8'
                            });
                            
                            if (result.isConfirmed) {
                                console.log('‚úÖ Redirigiendo a MercadoPago...');
                                window.location.href = preference.init_point;
                            } else {
                                this.setLoadingState(false);
                                this.isProcessing = false;
                            }
                    } else {
                        throw new Error('No se pudo crear la preferencia de pago');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en Checkout Pro:', error);
                    throw error;
                }
            }

            prepareEnhancedPaymentData() {
                const items = this.cart.map(item => ({
                    title: item.nombre || item.name || 'Producto',
                    unit_price: parseFloat(item.precio || item.price || 0),
                    quantity: parseInt(item.cantidad || item.quantity || 1),
                    currency_id: 'COP'
                }));

                // Agregar env√≠o como item
                items.push({
                    title: 'Env√≠o',
                    unit_price: 0, // ENV√çO GRATIS
                    quantity: 1,
                    currency_id: 'COP'
                });

                // Obtener datos del formulario de pago
                const cardHolderName = document.getElementById('cardHolder')?.value || '';
                const email = document.getElementById('email')?.value || '';
                const documentType = document.getElementById('documentType')?.value || 'CC';
                const documentNumber = document.getElementById('documentNumber')?.value || '';

                // Obtener datos del formulario de env√≠o
                const shippingData = this.getShippingData();

                return {
                    items: items,
                    back_urls: {
                        success: window.location.origin + '/Musa/success-premium.html',
                        failure: window.location.origin + '/Musa/failure-premium.html',
                        pending: window.location.origin + '/Musa/pending-premium.html'
                    },
                    payer: {
                        name: cardHolderName.split(' ')[0] || shippingData.nombre_completo.split(' ')[0] || '',
                        surname: cardHolderName.split(' ').slice(1).join(' ') || shippingData.nombre_completo.split(' ').slice(1).join(' ') || '',
                        email: email,
                        phone: {
                            area_code: '57',
                            number: shippingData.telefono.replace(/\s+/g, '')
                        },
                        identification: {
                            type: documentType,
                            number: documentNumber || document.getElementById('idNumber')?.value || ''
                        },
                        address: {
                            street_name: shippingData.direccion,
                            street_number: '1',
                            zip_code: shippingData.codigo_postal || '000001'
                        }
                    },
                    shipments: {
                        cost: 0, // ENV√çO GRATIS
                        mode: 'not_specified',
                        receiver_address: {
                            street_name: shippingData.direccion,
                            street_number: '1',
                            zip_code: shippingData.codigo_postal || '000001',
                            city_name: shippingData.ciudad,
                            state_name: shippingData.departamento
                        }
                    },
                    external_reference: 'MUSA-HYBRID-' + Date.now(),
                    expires: true,
                    expiration_date_from: new Date().toISOString(),
                    expiration_date_to: new Date(Date.now() + 30 * 60 * 1000).toISOString() // 30 minutos
                };
            }

            getShippingData() {
                try {
                    // Obtener datos de env√≠o desde localStorage
                    const shippingData = localStorage.getItem('shipping_data');
                    if (shippingData) {
                        const data = JSON.parse(shippingData);
                        
                        // Mapeo de c√≥digos de ciudad a nombres completos
                        const cityNames = {
                            'bogota': 'Bogot√° D.C.',
                            'medellin': 'Medell√≠n',
                            'cali': 'Cali',
                            'barranquilla': 'Barranquilla',
                            'cartagena': 'Cartagena',
                            'bucaramanga': 'Bucaramanga',
                            'cucuta': 'C√∫cuta',
                            'pereira': 'Pereira',
                            'ibague': 'Ibagu√©',
                            'armenia': 'Armenia',
                            'manizales': 'Manizales',
                            'neiva': 'Neiva'
                        };

                        // Mapeo de c√≥digos de departamento a nombres completos
                        const departmentNames = {
                            'cundinamarca': 'Cundinamarca',
                            'antioquia': 'Antioquia',
                            'valle': 'Valle del Cauca',
                            'atlantico': 'Atl√°ntico',
                            'bolivar': 'Bol√≠var',
                            'santander': 'Santander',
                            'norte_santander': 'Norte de Santander',
                            'risaralda': 'Risaralda',
                            'tolima': 'Tolima',
                            'magdalena': 'Magdalena',
                            'meta': 'Meta',
                            'caldas': 'Caldas',
                            'huila': 'Huila'
                        };

                        const cityName = cityNames[data.city] || data.city || 'No especificada';
                        const departmentName = departmentNames[data.department] || data.department || 'No especificado';

                        console.log('üîç Datos de env√≠o cargados desde localStorage:', data);

                        return {
                            nombre_completo: data.fullName || 'No especificado',
                            email: data.email || 'No especificado',
                            telefono: data.phone || 'No especificado',
                            direccion: data.address || 'No especificada',
                            ciudad: cityName,
                            departamento: departmentName,
                            codigo_postal: data.postalCode || '',
                            notas_entrega: data.deliveryNotes || '',
                            costo_envio: data.shippingCost || 0
                        };
                    }
                } catch (error) {
                    console.error('‚ùå Error cargando datos de env√≠o:', error);
                }

                // Fallback si no hay datos guardados
                console.warn('‚ö†Ô∏è No hay datos de env√≠o en localStorage');
                
                console.log('üîç Usando datos de env√≠o por defecto:', {
                    phone,
                    address,
                    cityCode,
                    departmentCode,
                    postalCode,
                    deliveryNotes
                });

                // ‚ö†Ô∏è CR√çTICO: Mapeo EXACTO a los nombres de campos de la base de datos
                const shippingData = {
                    // Campos EXACTOS para tabla 'envios' (REQUERIDOS)
                    nombre_completo: fullName,
                    email: email,
                    telefono: phone,
                    departamento: departmentNames[departmentCode] || departmentCode,
                    ciudad: cityNames[cityCode] || cityCode,
                    direccion: address,
                    // Campos OPCIONALES
                    codigo_postal: postalCode || null,
                    notas_adicionales: deliveryNotes || null
                };

                return {
                    nombre_completo: 'Cliente sin informaci√≥n',
                    email: 'no-email@example.com',
                    telefono: '000-000-0000',
                    direccion: 'Direcci√≥n no especificada',
                    ciudad: 'Ciudad no especificada',
                    departamento: 'Departamento no especificado',
                    codigo_postal: '',
                    notas_entrega: '',
                    costo_envio: 0
                };
            }

            detectPaymentMethod(cardNumber) {
                // Remover espacios y caracteres no num√©ricos
                const cleanNumber = cardNumber.replace(/\D/g, '');
                
                // Detectar tipo de tarjeta basado en los primeros d√≠gitos
                if (cleanNumber.startsWith('4')) {
                    return 'visa';
                } else if (cleanNumber.startsWith('5') || cleanNumber.startsWith('2')) {
                    return 'master';
                } else if (cleanNumber.startsWith('3')) {
                    return 'amex';
                } else if (cleanNumber.startsWith('6')) {
                    return 'discover';
                }
                
                // Fallback a visa para tarjetas de prueba de MercadoPago
                return 'visa';
            }

            async processCardPayment() {
                try {
                    console.log('üí≥ Procesando pago con tarjeta...');
                    
                    // 1. Tokenizar la tarjeta
                    const cardToken = await this.createCardToken();
                    console.log('üîë Token de tarjeta creado:', cardToken.id);
                    
                    // 2. Procesar el pago con el token
                    const payment = await this.createPayment(cardToken);
                    console.log('‚úÖ Pago procesado:', payment);
                    
                    // 3. Manejar resultado seg√∫n el estado del pago
                    if (payment.status === 'approved') {
                        console.log('üíæ Guardando pedido exitoso en base de datos...');
                        try {
                            const paymentData = this.prepareEnhancedPaymentData();
                            const saveResult = await this.saveOrderToDatabase(payment, paymentData);
                            
                            if (saveResult.success) {
                                console.log('‚úÖ Pedido guardado exitosamente:', saveResult.pedido_id);
                                payment.pedido_id = saveResult.pedido_id;
                            } else {
                                console.log('‚ö†Ô∏è Error guardando pedido:', saveResult.message);
                            }
                        } catch (saveError) {
                            console.error('‚ùå Error en guardado:', saveError);
                        }
                    } else if (payment.status === 'pending') {
                        console.log('‚è≥ Pago pendiente - no se guarda hasta confirmaci√≥n');
                    } else if (payment.status === 'rejected') {
                        console.log('‚ùå Pago rechazado - no se guarda pedido');
                    }
                    
                    // 4. Mostrar resultado sin redirecci√≥n
                    this.showPaymentResult(payment);
                    
                } catch (error) {
                    console.error('‚ùå Error en pago con tarjeta:', error);
                    throw error;
                }
            }

            async createCardToken() {
                return new Promise((resolve, reject) => {
                    try {
                        // Obtener datos del documento
                        const documentType = document.getElementById('documentType').value;
                        const documentNumber = document.getElementById('documentNumber').value;
                        const expiryValue = document.getElementById('expiryDate').value;
                        
                        // Validar que tenemos todos los datos
                        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                        const cardholderName = document.getElementById('cardHolder').value;
                        const securityCode = document.getElementById('cvv').value;
                        
                        console.log('üîç Datos del formulario:', {
                            cardNumber: cardNumber.slice(0, 4) + '****',
                            cardholderName,
                            expiryValue,
                            securityCode: securityCode ? '***' : 'VAC√çO',
                            documentType,
                            documentNumber
                        });
                        
                        // Validar campos obligatorios
                        if (!cardNumber || cardNumber.length < 13) {
                            throw new Error('N√∫mero de tarjeta inv√°lido');
                        }
                        if (!cardholderName || cardholderName.trim().length < 2) {
                            throw new Error('Nombre del titular inv√°lido');
                        }
                        if (!securityCode || securityCode.length < 3) {
                            throw new Error('C√≥digo de seguridad inv√°lido');
                        }
                        if (!expiryValue || !expiryValue.includes('/')) {
                            throw new Error('Fecha de vencimiento inv√°lida');
                        }
                        if (!documentNumber || documentNumber.length < 5) {
                            throw new Error('N√∫mero de documento inv√°lido');
                        }
                        
                        const [month, year] = expiryValue.split('/');
                        
                        const cardForm = {
                            cardNumber: cardNumber,
                            cardholderName: cardholderName.trim(),
                            cardExpirationMonth: month.padStart(2, '0'),
                            cardExpirationYear: '20' + year,
                            securityCode: securityCode,
                            identificationType: documentType || 'CC',
                            identificationNumber: documentNumber
                        };
                        
                        console.log('üìã Enviando datos a MercadoPago:', {
                            ...cardForm,
                            cardNumber: cardForm.cardNumber.slice(0, 4) + '****',
                            securityCode: '***'
                        });
                        
                        // üî¥ PRODUCCI√ìN: Simulaci√≥n desactivada - Usar APIs reales de MercadoPago
                        /*
                        // En modo testing, simular respuesta si las credenciales no funcionan
                        if (window.location.hostname === 'localhost') {
                            console.log('üß™ Modo localhost detectado - Simulando token...');
                            setTimeout(() => {
                                const simulatedToken = {
                                    id: 'TEST-TOKEN-' + Date.now(),
                                    payment_method_id: 'visa',
                                    cardholder: {
                                        identification: {
                                            type: documentType || 'CC',
                                            number: documentNumber
                                        },
                                        name: cardholderName.trim()
                                    },
                                    simulated: true
                                };
                                console.log('‚úÖ Token simulado creado:', simulatedToken.id);
                                resolve(simulatedToken);
                            }, 500);
                            return;
                        }
                        */
                        
                        this.mp.createCardToken(cardForm).then(token => {
                            console.log('‚úÖ Token creado exitosamente:', token.id);
                            
                            // Asegurar que el token incluya payment_method_id
                            if (!token.payment_method_id) {
                                token.payment_method_id = this.detectPaymentMethod(cardForm.cardNumber);
                                console.log(`üîç Payment method agregado al token: ${token.payment_method_id}`);
                            }
                            
                            resolve(token);
                        }).catch(error => {
                            console.error('‚ùå Error detallado de MercadoPago:', error);
                            
                            // Fallback a simulaci√≥n si falla en testing
                            if (cardForm.identificationType && cardForm.identificationNumber) {
                                console.log('üîÑ Fallback a simulaci√≥n...');
                                const detectedMethod = this.detectPaymentMethod(cardForm.cardNumber);
                                const simulatedToken = {
                                    id: 'TEST-FALLBACK-' + Date.now(),
                                    payment_method_id: detectedMethod,
                                    cardholder: {
                                        identification: {
                                            type: cardForm.identificationType,
                                            number: cardForm.identificationNumber
                                        },
                                        name: cardForm.cardholderName
                                    },
                                    simulated: true
                                };
                                console.log(`‚úÖ Token simulado creado con m√©todo: ${detectedMethod}`);
                                resolve(simulatedToken);
                            } else {
                                reject(new Error('Error procesando la tarjeta: ' + (error.message || 'Datos inv√°lidos')));
                            }
                        });
                        
                    } catch (validationError) {
                        console.error('‚ùå Error de validaci√≥n:', validationError.message);
                        reject(validationError);
                    }
                });
            }

            async processNequiDaviplataPayment() {
                try {
                    console.log('üì± Procesando pago con Nequi/Daviplata...');
                    
                    // Recopilar datos del formulario
                    const receiptFile = document.getElementById('receiptUpload').files[0];
                    const senderName = document.getElementById('senderName').value.trim();
                    const transferAmount = this.getTotalAmount();
                    
                    // Preparar datos de env√≠o
                    const shippingData = this.getShippingData();
                    
                    // Obtener email del formulario de env√≠o
                    const buyerEmail = shippingData.email || document.getElementById('email')?.value || '';
                    
                    // Convertir imagen a base64
                    const receiptBase64 = await this.fileToBase64(receiptFile);
                    
                    const paymentData = {
                        payment_method: 'nequi_daviplata',
                        amount: transferAmount,
                        sender_name: senderName,
                        buyer_email: buyerEmail,
                        receipt_image: receiptBase64,
                        items: this.cart,
                        shipping: shippingData,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('üì° Enviando datos de pago Nequi/Daviplata...');
                    
                    // Enviar al servidor
                    const response = await fetch('api/process-nequi-payment.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error del servidor: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.message);
                    }
                    
                    // Mostrar resultado exitoso
                    const mockPayment = {
                        status: 'pending',
                        status_detail: 'pending_transfer_confirmation',
                        payment_method_id: 'nequi_daviplata',
                        transaction_amount: transferAmount,
                        payment_type_id: 'digital_wallet',
                        pedido_id: result.pedido_id || 'NQ' + Date.now(),
                        description: 'Pago con Nequi/Daviplata pendiente de confirmaci√≥n'
                    };
                    
                    this.showPaymentResult(mockPayment);
                    
                } catch (error) {
                    console.error('‚ùå Error en pago con Nequi/Daviplata:', error);
                    throw error;
                }
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            async createPayment(cardToken) {
                const emailField = document.getElementById('email');
                const email = emailField ? emailField.value : 'cliente@musa.com';
                
                // Detectar payment_method_id si no est√° presente
                let paymentMethodId = cardToken.payment_method_id;
                if (!paymentMethodId) {
                    // Detectar autom√°ticamente basado en el n√∫mero de tarjeta
                    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                    paymentMethodId = this.detectPaymentMethod(cardNumber);
                    console.log(`üîç Payment method detectado autom√°ticamente: ${paymentMethodId}`);
                }
                
                // Validar campos requeridos
                if (!cardToken.id) {
                    throw new Error('Token de tarjeta requerido');
                }
                if (!paymentMethodId) {
                    throw new Error('M√©todo de pago requerido');
                }
                if (!email) {
                    throw new Error('Email requerido');
                }
                
                const paymentData = {
                    token: cardToken.id,
                    installments: parseInt(document.getElementById('installments').value) || 1,
                    payment_method_id: paymentMethodId,
                    transaction_amount: this.getTotalAmount(),
                    description: this.getPaymentDescription(),
                    payer: {
                        email: email,
                        name: cardToken.cardholder.name, // Nombre del titular para simulaci√≥n
                        identification: {
                            type: cardToken.cardholder.identification.type,
                            number: cardToken.cardholder.identification.number
                        }
                    }
                };
                
                // Validaci√≥n final de campos requeridos
                console.log('üîç Validando datos de pago antes del env√≠o:', {
                    token: paymentData.token ? 'PRESENTE' : 'FALTANTE',
                    payment_method_id: paymentData.payment_method_id || 'FALTANTE',
                    transaction_amount: paymentData.transaction_amount,
                    installments: paymentData.installments,
                    email: paymentData.payer?.email || 'FALTANTE'
                });
                
                if (!paymentData.payment_method_id) {
                    throw new Error('Campo requerido faltante: payment_method_id');
                }
                
                console.log('üì° Enviando datos de pago:', paymentData);
                
                // Usar archivo espec√≠fico seg√∫n el modo
                const apiEndpoint = this.config.environment === 'sandbox' ? 
                    'api/process-payment-test.php' : 
                    'api/process-payment.php';
                
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    // Error del servidor (incluyendo pagos rechazados)
                    if (result.status === 'rejected') {
                        // Es un pago rechazado, devolver los datos del rechazo
                        return {
                            status: 'rejected',
                            status_detail: result.status_detail || 'Pago rechazado',
                            id: result.payment_data?.id || 'REJECTED-' + Date.now(),
                            message: result.message
                        };
                    } else {
                        // Otro tipo de error
                        throw new Error(result.message || `Error del servidor: ${response.status}`);
                    }
                }
                
                if (result.error && result.status !== 'rejected') {
                    throw new Error(result.message);
                }
                
                return result;
            }

            showPaymentResult(payment) {
                this.setLoadingState(false);
                this.isProcessing = false;
                
                let icon, title, message;
                
                switch (payment.status) {
                    case 'approved':
                        icon = 'success';
                        title = '¬°Pago Exitoso!';
                        message = `Tu pago ha sido aprobado.<br>ID: ${payment.id}`;
                        // Solo limpiar carrito si el pago fue exitoso
                        localStorage.removeItem('carrito');
                        break;
                    case 'pending':
                        icon = 'warning';
                        title = 'Pago Pendiente';
                        message = `Tu pago est√° siendo procesado.<br>ID: ${payment.id}`;
                        break;
                    case 'rejected':
                        icon = 'error';
                        title = 'Pago Rechazado';
                        message = `El pago fue rechazado.<br>Motivo: ${payment.status_detail || 'Tarjeta no v√°lida'}<br><br>Por favor, intenta con otra tarjeta.`;
                        // NO limpiar carrito para que pueda intentar de nuevo
                        break;
                    default:
                        icon = 'error';
                        title = 'Error en el Pago';
                        message = payment.status_detail || 'El pago no pudo ser procesado.';
                }
                
                Swal.fire({
                    icon: icon,
                    title: title,
                    html: message,
                    showConfirmButton: true,
                    confirmButtonText: payment.status === 'rejected' ? 'Intentar de Nuevo' : 'Continuar',
                    allowOutsideClick: false
                }).then(() => {
                    if (payment.status === 'approved') {
                        // Guardar m√©todo de pago seleccionado
                        localStorage.setItem('selected_payment_method', this.activePaymentMethod || 'card');
                        
                        // Redirigir a p√°gina de confirmaci√≥n con datos del pago
                        const confirmationUrl = `confirmacion-premium.html?payment_id=${payment.id}&status=${payment.status}`;
                        window.location.href = confirmationUrl;
                    } else if (payment.status === 'rejected') {
                        // Si fue rechazado, permitir que intente de nuevo
                        // No hacer nada, se queda en la p√°gina
                        console.log('üîÑ Pago rechazado - usuario puede intentar de nuevo');
                    } else {
                        // Para pending u otros estados, redirigir
                        window.location.href = 'index.html';
                    }
                });
            }

            getTotalAmount() {
                const total = this.cart.reduce((sum, item) => {
                    return sum + (parseFloat(item.precio || item.price || 0) * parseInt(item.cantidad || item.quantity || 1));
                }, 0);
                return total + 0; // ENV√çO GRATIS
            }

            getPaymentDescription() {
                const items = this.cart.map(item => item.nombre || item.name).join(', ');
                return `MUSA Fashion - ${items}`;
            }

            /**
             * Procesa el pago con MercadoPago de forma unificada
             * Maneja todos los m√©todos de pago (tarjetas, PSE, etc.)
             */
            async processMercadoPagoPayment() {
                try {
                    console.log('üöÄ Iniciando procesamiento con MercadoPago unificado...');
                    
                    // Obtener datos del carrito
                    const cartData = this.getCartData();
                    console.log('üõí CartData obtenido:', cartData);
                    console.log('üõí Tipo de cartData:', typeof cartData);
                    console.log('üõí Es array?', Array.isArray(cartData));
                    
                    if (!cartData || cartData.length === 0) {
                        this.showAlert('No se encontraron productos en el carrito', 'error');
                        this.setLoadingState(false);
                        this.isProcessing = false;
                        return;
                    }
                    
                    // Para MercadoPago no necesitamos datos de env√≠o, se capturan en la plataforma
                    console.log('üéØ MercadoPago: Usando datos m√≠nimos para redirecci√≥n directa');
                    
                    // Preparar items para MercadoPago
                    const mappedItems = cartData.map(item => {
                        console.log('üè∑Ô∏è Procesando item:', item);
                        const mappedItem = {
                            title: item.name || item.title || 'Producto',
                            description: item.description || item.name || 'Producto MUSA Fashion',
                            picture_url: item.image || '',
                            category_id: 'clothing',
                            quantity: parseInt(item.quantity) || 1,
                            currency_id: 'COP',
                            unit_price: parseFloat(item.price) || 0
                        };
                        console.log('üì¶ Item mapeado:', mappedItem);
                        return mappedItem;
                    });
                    
                    console.log('üì¶ Todos los items mapeados:', mappedItems);
                    
                    // Preparar datos de la preferencia con informaci√≥n m√≠nima
                    const preferenceData = {
                        items: mappedItems,
                        payer: {
                            name: 'Comprador',
                            surname: 'MUSA Fashion',
                            email: 'cliente@musafashion.com'
                        },
                        back_urls: {
                            success: "https://www.google.com",
                            failure: "https://www.google.com", 
                            pending: "https://www.google.com"
                        },
                        external_reference: `order_${Date.now()}`,
                        notification_url: `${window.location.origin}/Musa/webhook-mercadopago.php`
                    };
                    
                    console.log('üìã Datos de preferencia preparados:', preferenceData);
                    console.log('üì§ JSON enviado:', JSON.stringify(preferenceData, null, 2));
                    
                    // Crear preferencia
                    const response = await fetch('http://localhost/Musa/Musa/create-preference-simple.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(preferenceData)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Error del servidor:', {
                            status: response.status,
                            statusText: response.statusText,
                            response: errorText
                        });
                        throw new Error(`Error en el servidor: ${response.status} - ${errorText}`);
                    }
                    
                    const result = await response.json();
                    console.log('‚úÖ Respuesta del servidor:', result);
                    
                    if (result.success && result.preference_id) {
                        // Guardar informaci√≥n del pedido en localStorage
                        const orderInfo = {
                            preference_id: result.preference_id,
                            external_reference: preferenceData.external_reference,
                            items: preferenceData.items,
                            payer: preferenceData.payer,
                            total: cartData.reduce((total, item) => total + (item.price * item.quantity), 0),
                            created_at: new Date().toISOString()
                        };
                        
                        localStorage.setItem('currentOrder', JSON.stringify(orderInfo));
                        console.log('üíæ Informaci√≥n del pedido guardada:', orderInfo);
                        
                        // Verificar el tipo de entorno
                        if (result.environment === 'SIMULATION') {
                            this.showAlert('üéÆ MODO SIMULACI√ìN: No hay redirecci√≥n real', 'info');
                            console.log('üéØ SIMULACI√ìN: En producci√≥n se redirigir√≠a a:', result.init_point);
                            
                            setTimeout(() => {
                                this.showAlert('‚úÖ Pago simulado exitoso (DESARROLLO)', 'success');
                                console.log('üîó Para pruebas reales configura Sandbox en create-preference-simple.php');
                            }, 2000);
                            
                        } else if (result.environment === 'SANDBOX') {
                            this.showAlert('üèñÔ∏è SANDBOX: Redirigiendo a MercadoPago TEST...', 'info');
                            console.log('üèñÔ∏è SANDBOX: Redirigiendo a entorno de pruebas:', result.sandbox_init_point || result.init_point);
                            
                            // Redireccionar al Sandbox de MercadoPago
                            setTimeout(() => {
                                window.location.href = result.sandbox_init_point || result.init_point;
                            }, 1500);
                            
                        } else {
                            // PRODUCCI√ìN
                            this.showAlert('Redirigiendo a MercadoPago...', 'success');
                            console.log('üîó PRODUCCI√ìN: Redirigiendo a:', result.init_point);
                            window.location.href = result.init_point;
                        }
                        
                    } else {
                        throw new Error(result.message || 'Error al crear la preferencia de pago');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en procesamiento MercadoPago:', error);
                    this.showAlert(
                        error.message || 'Error al procesar el pago. Por favor intenta nuevamente.',
                        'error'
                    );
                    this.setLoadingState(false);
                    this.isProcessing = false;
                }
            }

            async processPSEPayment() {
                try {
                    console.log('üè¶ Iniciando proceso de pago PSE con Checkout Pro...');
                    
                    // Mostrar indicador de carga
                    this.isProcessing = true;
                    this.updatePayButton('‚è≥ Creando preferencia de pago...', true);
                    
                    // Crear preferencia para PSE (Checkout Pro)
                    const preference = await this.createPSEPreference();
                    
                    if (preference && preference.init_point) {
                        console.log('‚úÖ Preferencia PSE creada exitosamente');
                        console.log('üîó Redirigiendo a:', preference.init_point);
                        
                        // Guardar datos del carrito antes de redireccionar
                        this.saveCheckoutData();
                        
                        // Redireccionar a MercadoPago PSE
                        window.location.href = preference.init_point;
                        
                    } else {
                        throw new Error('Error al crear la preferencia de pago PSE');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en proceso PSE:', error);
                    this.showAlert(`Error al procesar pago PSE: ${error.message}`, 'error');
                    
                    // Restaurar bot√≥n
                    this.isProcessing = false;
                    this.updatePayButton('üí≥ Procesar Pago', false);
                }
            }

            async createPSEPreference() {
                try {
                    console.log('üîß Creando preferencia PSE para Checkout Pro...');
                    
                    // Obtener datos de env√≠o del localStorage
                    const shippingData = JSON.parse(localStorage.getItem('shipping_data') || '{}');
                    
                    const preferenceData = {
                        items: this.cart.map(item => ({
                            title: item.nombre || item.name || 'Producto',
                            quantity: parseInt(item.cantidad || item.quantity || 1),
                            unit_price: parseFloat(item.precio || item.price || 0),
                            currency_id: 'COP'
                        })),
                        payer: {
                            name: shippingData.fullName || 'Cliente',
                            email: shippingData.email || 'cliente@ejemplo.com',
                            phone: {
                                number: shippingData.phone || ''
                            },
                            address: {
                                street_name: shippingData.address || '',
                                city: shippingData.city || '',
                                state: shippingData.department || '',
                                zip_code: shippingData.postalCode || ''
                            }
                        },
                        payment_methods: {
                            excluded_payment_types: ["credit_card", "debit_card", "ticket", "bank_transfer"],
                            excluded_payment_methods: [],
                            included_payment_methods: ["pse"]
                        },
                        back_urls: {
                            success: `${window.location.origin}/Musa/confirmacion-premium.html`,
                            failure: `${window.location.origin}/Musa/failure-premium.html`,
                            pending: `${window.location.origin}/Musa/pending-premium.html`
                        },
                        auto_return: "approved",
                        external_reference: `ORDER_${Date.now()}`,
                        notification_url: `${window.location.origin}/webhook.php`,
                        statement_descriptor: "MUSA FASHION",
                        additional_info: {
                            payment_method: 'pse',
                            shipping_cost: 0,
                            total_amount: this.getTotalAmount()
                        }
                    };
                    
                    console.log('üì¶ Datos de preferencia PSE:', preferenceData);
                    
                    // Llamar al endpoint para crear la preferencia
                    const response = await fetch('create-preference.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(preferenceData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('‚úÖ Preferencia PSE creada correctamente');
                        return result.preference;
                    } else {
                        throw new Error(result.message || 'Error al crear preferencia PSE');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error creando preferencia PSE:', error);
                    throw error;
                }
            }

            saveCheckoutData() {
                // Guardar datos importantes antes de redireccionar
                const checkoutData = {
                    cart: this.cart,
                    total: this.getTotalAmount(),
                    shipping: JSON.parse(localStorage.getItem('shipping_data') || '{}'),
                    timestamp: Date.now(),
                    payment_method: 'pse'
                };
                
                localStorage.setItem('checkout_data', JSON.stringify(checkoutData));
                console.log('üíæ Datos de checkout guardados para PSE');
            }

            async createPSEPreference() {
                try {
                    console.log('üè¶ Creando preferencia PSE...');
                    
                    // Obtener datos del carrito
                    const items = this.cart.map(item => ({
                        title: item.name || item.nombre || 'Producto',
                        unit_price: parseFloat(item.price || item.precio || 0),
                        quantity: parseInt(item.quantity || item.cantidad || 1)
                    }));
                    
                    // Obtener datos de env√≠o
                    const shippingData = JSON.parse(localStorage.getItem('shipping_data') || '{}');
                    
                    const preferenceData = {
                        items: items,
                        payer: {
                            name: shippingData.fullName || 'Cliente',
                            email: shippingData.email || 'cliente@example.com',
                            identification: {
                                type: 'CC',
                                number: '12345678'
                            }
                        },
                        back_urls: {
                            success: `${window.location.origin}/Musa/confirmacion-premium.html?status=approved`,
                            failure: `${window.location.origin}/Musa/failure-premium.html?status=failure`,
                            pending: `${window.location.origin}/Musa/failure-premium.html?status=pending`
                        },
                        auto_return: 'approved',
                        payment_methods: {
                            excluded_payment_types: [
                                { id: 'credit_card' },
                                { id: 'debit_card' },
                                { id: 'ticket' },
                                { id: 'bank_transfer' }
                            ],
                            included_payment_methods: [
                                { id: 'pse' }
                            ]
                        }
                    };
                    
                    const response = await fetch('create-preference.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(preferenceData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('‚úÖ Preferencia PSE creada:', result.preference);
                        return result.preference;
                    } else {
                        throw new Error(result.error || 'Error al crear preferencia PSE');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error creando preferencia PSE:', error);
                    throw error;
                }
            }

            async openPSEModal(preference, bankName) {
                return new Promise((resolve) => {
                    // Guardar datos del pago PSE para monitoreo
                    this.psePaymentData = {
                        preference_id: preference.id,
                        init_point: preference.init_point,
                        bank: bankName,
                        amount: this.getTotalAmount(),
                        timestamp: Date.now()
                    };
                    
                    // Guardar en localStorage para detectar retorno
                    localStorage.setItem('psePaymentPending', JSON.stringify(this.psePaymentData));
                    
                    Swal.fire({
                        title: false,
                        html: `
                            <div class="pse-container">
                                <div class="pse-loading" id="pseLoading">
                                    <div class="spinner"></div>
                                    <p>Conectando con ${this.getBankDisplayName(bankName)}...</p>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-clock"></i> Esto puede tomar hasta 30 segundos
                                    </small>
                                </div>
                                
                                <iframe id="pseFrame" 
                                        src="${preference.init_point}" 
                                        style="display: none;"
                                        onload="
                                            console.log('‚úÖ Iframe PSE cargado exitosamente');
                                            this.style.display='block'; 
                                            this.classList.add('loaded');
                                            document.getElementById('pseLoading').style.display='none';
                                            // Limpiar timeout de iframe ya que carg√≥ correctamente
                                            if (window.paymentProcessor && window.paymentProcessor.iframeTimeout) {
                                                clearTimeout(window.paymentProcessor.iframeTimeout);
                                                window.paymentProcessor.iframeTimeout = null;
                                            }
                                        "
                                        onerror="
                                            console.error('‚ùå Error cargando iframe PSE');
                                            document.getElementById('pseLoading').innerHTML = 
                                                '<div class=\'text-danger\'><i class=\'fas fa-exclamation-triangle\'></i> Error de conexi√≥n con el banco</div>';
                                        ">
                                </iframe>
                            </div>
                        `,
                        width: '90%',
                        showConfirmButton: false,
                        showCloseButton: true,
                        allowOutsideClick: false,
                        customClass: {
                            popup: 'pse-modal-container'
                        },
                        didOpen: () => {
                            console.log('üè¶ Modal PSE abierto, iniciando monitoreo...');
                            
                            // Agregar bot√≥n de emergencia despu√©s de 15 segundos
                            setTimeout(() => {
                                const loading = document.getElementById('pseLoading');
                                if (loading && loading.style.display !== 'none') {
                                    const emergencyButton = document.createElement('div');
                                    emergencyButton.innerHTML = `
                                        <div style="margin-top: 20px;">
                                            <button class="btn btn-outline-primary btn-sm" onclick="window.paymentProcessor.showPSELoadingIssue()">
                                                <i class="fas fa-exclamation-triangle"></i> ¬øProblemas de conexi√≥n?
                                            </button>
                                        </div>
                                    `;
                                    loading.appendChild(emergencyButton);
                                }
                            }, 15000);
                            
                            // Optimizaciones espec√≠ficas para m√≥vil
                            const isMobile = window.innerWidth <= 768;
                            
                            if (isMobile) {
                                // Prevenir zoom en iOS
                                const viewport = document.querySelector("meta[name=viewport]");
                                if (viewport) {
                                    viewport.setAttribute('content', 
                                        'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover'
                                    );
                                }
                                
                                // Ocultar barra de direcciones en m√≥viles
                                window.scrollTo(0, 1);
                                
                                // Ajustar altura del iframe din√°micamente
                                const adjustIframeHeight = () => {
                                    const iframe = document.getElementById('pseFrame');
                                    if (iframe) {
                                        const windowHeight = window.innerHeight;
                                        iframe.style.height = windowHeight + 'px';
                                    }
                                };
                                
                                // Ajustar altura inicial y en cambios de orientaci√≥n
                                setTimeout(adjustIframeHeight, 100);
                                window.addEventListener('orientationchange', () => {
                                    setTimeout(adjustIframeHeight, 500);
                                });
                                window.addEventListener('resize', adjustIframeHeight);
                                
                                // Guardar referencia para cleanup
                                this.pseAdjustHeight = adjustIframeHeight;
                            }
                            
                            this.startPSEMonitoring();
                        },
                        willClose: () => {
                            console.log('üè¶ Modal PSE cerrado por el usuario');
                            
                            // Limpiar optimizaciones m√≥viles
                            if (this.pseAdjustHeight) {
                                window.removeEventListener('orientationchange', this.pseAdjustHeight);
                                window.removeEventListener('resize', this.pseAdjustHeight);
                                this.pseAdjustHeight = null;
                            }
                            
                            // Restaurar viewport original
                            const viewport = document.querySelector("meta[name=viewport]");
                            if (viewport) {
                                viewport.setAttribute('content', 
                                    'width=device-width, initial-scale=1, viewport-fit=cover'
                                );
                            }
                            
                            this.stopPSEMonitoring();
                            resolve({ cancelled: true });
                        }
                    });
                });
            }

            startPSEMonitoring() {
                console.log('üëÄ Iniciando monitoreo de PSE...');
                
                // Monitorear cada 2 segundos
                this.pseMonitorInterval = setInterval(() => {
                    this.checkPSEStatus();
                }, 2000);
                
                // Timeout m√°s corto para evitar esperas infinitas - 5 minutos
                this.pseTimeout = setTimeout(() => {
                    this.stopPSEMonitoring();
                    this.showPSEConnectionIssue();
                }, 300000); // 5 minutos
                
                // Timeout para iframe que no carga - 30 segundos
                this.iframeTimeout = setTimeout(() => {
                    const iframe = document.getElementById('pseFrame');
                    const loading = document.getElementById('pseLoading');
                    
                    if (loading && loading.style.display !== 'none') {
                        console.warn('‚ö†Ô∏è El iframe de PSE no carg√≥ en 30 segundos, ofreciendo alternativa');
                        this.showPSELoadingIssue();
                    }
                }, 30000); // 30 segundos
            }

            stopPSEMonitoring() {
                if (this.pseMonitorInterval) {
                    clearInterval(this.pseMonitorInterval);
                    this.pseMonitorInterval = null;
                }
                
                if (this.pseTimeout) {
                    clearTimeout(this.pseTimeout);
                    this.pseTimeout = null;
                }
                
                if (this.iframeTimeout) {
                    clearTimeout(this.iframeTimeout);
                    this.iframeTimeout = null;
                }
            }

            async checkPSEStatus() {
                try {
                    // Verificar si hay par√°metros de retorno en la URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const status = urlParams.get('collection_status');
                    const paymentId = urlParams.get('payment_id');
                    
                    if (status || paymentId) {
                        console.log('‚úÖ Detectado retorno PSE:', { status, paymentId });
                        this.stopPSEMonitoring();
                        Swal.close();
                        this.handlePSEReturn(status, paymentId);
                        return;
                    }
                    
                    // Verificar en localStorage si hay un pago completado
                    const completedPayment = localStorage.getItem('psePaymentCompleted');
                    if (completedPayment) {
                        console.log('‚úÖ PSE completado detectado en localStorage');
                        const paymentData = JSON.parse(completedPayment);
                        this.stopPSEMonitoring();
                        Swal.close();
                        localStorage.removeItem('psePaymentCompleted');
                        this.handlePSEReturn(paymentData.status, paymentData.payment_id);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error verificando estado PSE:', error);
                }
            }

            handlePSEReturn(status, paymentId) {
                console.log(`üè¶ PSE retornado: ${status} - ID: ${paymentId}`);
                
                // Limpiar datos pendientes
                localStorage.removeItem('psePaymentPending');
                
                if (status === 'approved' || status === 'pending') {
                    // Mostrar resultado positivo
                    const mockPayment = {
                        status: status,
                        id: paymentId || 'PSE-' + Date.now(),
                        payment_method_id: 'pse',
                        transaction_amount: this.getTotalAmount(),
                        status_detail: status === 'approved' ? 'accredited' : 'pending_review'
                    };
                    
                    if (status === 'approved') {
                        // Solo guardar si est√° aprobado
                        this.saveOrderToDatabase(mockPayment, this.prepareEnhancedPaymentData());
                    }
                    
                    this.showPaymentResult(mockPayment);
                } else {
                    // Pago rechazado o cancelado
                    this.showPSEFailure(status);
                }
            }

            showPSETimeout() {
                Swal.fire({
                    icon: 'warning',
                    title: '‚è∞ Tiempo Agotado',
                    html: `
                        <p>El tiempo para completar el pago PSE ha expirado.</p>
                        <p>Puedes intentar nuevamente o elegir otro m√©todo de pago.</p>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Intentar de Nuevo',
                    cancelButtonText: 'Elegir Otro M√©todo'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Reintentar PSE
                        this.processPSEPayment();
                    }
                });
            }

            showPSEFailure(status) {
                Swal.fire({
                    icon: 'error',
                    title: '‚ùå Pago PSE Fallido',
                    html: `
                        <p>El pago PSE no pudo completarse.</p>
                        <p><strong>Estado:</strong> ${status || 'Cancelado'}</p>
                        <br>
                        <p>Puedes intentar nuevamente o elegir otro m√©todo de pago.</p>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Intentar de Nuevo',
                    cancelButtonText: 'Elegir Otro M√©todo'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Reintentar PSE
                        this.processPSEPayment();
                    }
                });
            }

            getBankDisplayName(bankCode) {
                const bankNames = {
                    'bancolombia': 'Bancolombia',
                    'banco_bogota': 'Banco de Bogot√°',
                    'banco_popular': 'Banco Popular',
                    'bbva': 'BBVA Colombia',
                    'davivienda': 'Davivienda',
                    'banco_occidente': 'Banco de Occidente',
                    'colpatria': 'Scotiabank Colpatria',
                    'banco_caja_social': 'Banco Caja Social',
                    'banco_av_villas': 'Banco AV Villas',
                    'citibank': 'Citibank',
                    'banco_gnb_sudameris': 'Banco GNB Sudameris',
                    'hsbc': 'HSBC Colombia',
                    'banco_falabella': 'Banco Falabella',
                    'banco_pichincha': 'Banco Pichincha',
                    'banco_cooperativo_coopcentral': 'Banco Cooperativo Coopcentral'
                };
                return bankNames[bankCode] || bankCode.charAt(0).toUpperCase() + bankCode.slice(1);
            }

            showPSELoadingIssue() {
                Swal.fire({
                    icon: 'warning',
                    title: '‚ö†Ô∏è Problema de Conectividad',
                    html: `
                        <p>El banco est√° tardando en responder. Esto puede deberse a:</p>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>Conexi√≥n lenta a internet</li>
                            <li>Mantenimiento del banco</li>
                            <li>Alto tr√°fico en el sistema PSE</li>
                        </ul>
                        <p><strong>¬øQu√© deseas hacer?</strong></p>
                    `,
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: 'üîÑ Reintentar',
                    denyButtonText: 'üåê Abrir en Nueva Ventana',
                    cancelButtonText: 'üì± Elegir Otro M√©todo',
                    confirmButtonColor: '#007bff',
                    denyButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Reintentar con iframe
                        location.reload();
                    } else if (result.isDenied) {
                        // Abrir en nueva ventana/pesta√±a
                        this.openPSEInNewWindow();
                    }
                    // Si cancela, se cierra autom√°ticamente y vuelve a m√©todos de pago
                });
            }

            showPSEConnectionIssue() {
                Swal.fire({
                    icon: 'error',
                    title: '‚è∞ Tiempo de Espera Agotado',
                    html: `
                        <p>La conexi√≥n con el banco ha tardado demasiado tiempo.</p>
                        <p>Por seguridad, hemos cancelado la transacci√≥n.</p>
                        <br>
                        <p><strong>Recomendaciones:</strong></p>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>Verifica tu conexi√≥n a internet</li>
                            <li>Intenta en unos minutos</li>
                            <li>Usa otro m√©todo de pago</li>
                        </ul>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'üîÑ Intentar de Nuevo',
                    cancelButtonText: 'üì± Otros M√©todos',
                    confirmButtonColor: '#007bff'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Reintentar PSE
                        this.processPSEPayment();
                    }
                });
            }

            async openPSEInNewWindow() {
                try {
                    if (this.psePaymentData && this.psePaymentData.init_point) {
                        // Cerrar modal actual
                        Swal.close();
                        
                        // Abrir PSE en nueva ventana
                        const newWindow = window.open(
                            this.psePaymentData.init_point,
                            'PSEPayment',
                            'width=800,height=600,scrollbars=yes,resizable=yes'
                        );
                        
                        if (newWindow) {
                            // Mostrar instrucciones
                            Swal.fire({
                                icon: 'info',
                                title: 'üåê PSE Abierto en Nueva Ventana',
                                html: `
                                    <p>Se ha abierto el pago PSE en una nueva ventana.</p>
                                    <p><strong>Instrucciones:</strong></p>
                                    <ol style="text-align: left; margin: 1rem 0;">
                                        <li>Completa el pago en la nueva ventana</li>
                                        <li>Al finalizar, regresa a esta pesta√±a</li>
                                        <li>Haz clic en "Verificar Pago" para confirmar</li>
                                    </ol>
                                `,
                                showCancelButton: true,
                                confirmButtonText: '‚úÖ Verificar Pago',
                                cancelButtonText: '‚ùå Cancelar Pago',
                                allowOutsideClick: false
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // Simular pago exitoso o verificar estado
                                    this.handlePSEReturn('pending', 'manual_verification');
                                }
                                // Si cancela, no hace nada (vuelve a m√©todos de pago)
                            });
                        } else {
                            throw new Error('No se pudo abrir la nueva ventana');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error abriendo PSE en nueva ventana:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo abrir el pago en una nueva ventana. Verifica que no est√©s bloqueando ventanas emergentes.'
                    });
                }
            }

            async processOtherPayment() {
                // Mantener el flujo actual para otros m√©todos de pago
                const paymentData = this.preparePaymentData();
                const preference = await this.createPreference(paymentData);
                
                if (preference.init_point) {
                    console.log('üöÄ Redirigiendo a MercadoPago para otros m√©todos...');
                    window.location.href = preference.init_point;
                } else {
                    throw new Error('No se pudo crear la preferencia de pago');
                }
            }

            validateForm() {
                console.log('üîç Iniciando validaci√≥n del formulario...');
                
                const activeMethodTab = document.querySelector('.method-tab.active');
                if (!activeMethodTab) {
                    console.log('‚ùå No hay m√©todo de pago activo');
                    this.showAlert('Por favor selecciona un m√©todo de pago', 'error');
                    return false;
                }
                
                const activeMethod = activeMethodTab.dataset.method;
                console.log('üí≥ M√©todo activo:', activeMethod);
                
                if (activeMethod === 'card' || activeMethod === 'credit_card' || activeMethod === 'debit_card') {
                    console.log('üîç Validando campos de tarjeta...');
                    
                    // Asegurar que el formulario de tarjeta est√© visible
                    const cardForm = document.getElementById('cardForm');
                    if (cardForm) {
                        cardForm.style.display = 'block';
                        console.log('‚úÖ Formulario de tarjeta activado');
                    }
                    
                    const cardNumberEl = document.getElementById('cardNumber');
                    const cardHolderEl = document.getElementById('cardHolder');
                    const expiryDateEl = document.getElementById('expiryDate');
                    const cvvEl = document.getElementById('cvv');
                    const documentTypeEl = document.getElementById('documentType');
                    const documentNumberEl = document.getElementById('documentNumber');
                    
                    console.log('üîç Elementos encontrados:', {
                        cardNumber: !!cardNumberEl,
                        cardHolder: !!cardHolderEl,
                        expiryDate: !!expiryDateEl,
                        cvv: !!cvvEl,
                        documentType: !!documentTypeEl,
                        documentNumber: !!documentNumberEl
                    });
                    
                    if (!cardNumberEl) {
                        console.log('‚ùå Campo cardNumber no encontrado');
                        this.showAlert('Completa el n√∫mero de tarjeta', 'error');
                        return false;
                    }
                    
                    if (!cardHolderEl) {
                        console.log('‚ùå Campo cardHolder no encontrado');
                        this.showAlert('Completa el nombre del titular', 'error');
                        return false;
                    }
                    
                    if (!expiryDateEl) {
                        console.log('‚ùå Campo expiryDate no encontrado');
                        this.showAlert('Completa la fecha de vencimiento', 'error');
                        return false;
                    }
                    
                    if (!cvvEl) {
                        console.log('‚ùå Campo cvv no encontrado');
                        this.showAlert('Completa el c√≥digo de seguridad', 'error');
                        return false;
                    }
                    
                    const cardNumber = cardNumberEl.value.replace(/\s/g, '');
                    const cardHolder = cardHolderEl.value.trim();
                    const expiryDate = expiryDateEl.value;
                    const cvv = cvvEl.value;
                    const documentType = documentTypeEl.value;
                    const documentNumber = documentNumberEl.value.trim();
                    
                    // Validar email tambi√©n
                    const emailEl = document.getElementById('email');
                    const email = emailEl ? emailEl.value.trim() : '';
                    
                    console.log('üîç Valores de campos:', {
                        cardNumber: cardNumber.length,
                        cardHolder: cardHolder.length,
                        expiryDate: expiryDate.length,
                        cvv: cvv.length,
                        email: email.length,
                        documentType: documentType,
                        documentNumber: documentNumber.length
                    });
                    
                    if (!cardNumber || cardNumber.length < 13) {
                        console.log('‚ùå N√∫mero de tarjeta inv√°lido:', cardNumber.length);
                        this.showAlert('Ingresa un n√∫mero de tarjeta v√°lido', 'error');
                        cardNumberEl.focus();
                        return false;
                    }
                    
                    if (!cardHolder) {
                        console.log('‚ùå Nombre del titular requerido');
                        this.showAlert('Ingresa el nombre del titular', 'error');
                        cardHolderEl.focus();
                        return false;
                    }
                    
                    if (!expiryDate || expiryDate.length !== 5) {
                        console.log('‚ùå Fecha de vencimiento inv√°lida:', expiryDate);
                        this.showAlert('Ingresa una fecha v√°lida (MM/AA)', 'error');
                        expiryDateEl.focus();
                        return false;
                    }
                    
                    if (!cvv || cvv.length < 3) {
                        console.log('‚ùå C√≥digo de seguridad inv√°lido:', cvv);
                        this.showAlert('Ingresa un c√≥digo de seguridad v√°lido', 'error');
                        cvvEl.focus();
                        return false;
                    }
                    
                    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        console.log('‚ùå Email inv√°lido:', email);
                        this.showAlert('Ingresa un email v√°lido', 'error');
                        if (emailEl) emailEl.focus();
                        return false;
                    }
                    
                    if (!documentNumber || documentNumber.length < 5) {
                        console.log('‚ùå N√∫mero de documento inv√°lido:', documentNumber);
                        this.showAlert('Ingresa un n√∫mero de documento v√°lido', 'error');
                        documentNumberEl.focus();
                        return false;
                    }
                } else if (activeMethod === 'nequi_daviplata') {
                    console.log('üîç Validando campos de Nequi/Daviplata...');
                    
                    const receiptUploadEl = document.getElementById('receiptUpload');
                    const senderNameEl = document.getElementById('senderName');
                    
                    if (!receiptUploadEl || !receiptUploadEl.files[0]) {
                        this.showAlert('Debes subir el comprobante de transferencia', 'error');
                        if (receiptUploadEl) receiptUploadEl.focus();
                        return false;
                    }
                    
                    if (!senderNameEl || !senderNameEl.value.trim()) {
                        this.showAlert('Ingresa el nombre de quien realiz√≥ la transferencia', 'error');
                        if (senderNameEl) senderNameEl.focus();
                        return false;
                    }
                    
                    console.log('‚úÖ Validaci√≥n de Nequi/Daviplata exitosa');
                } else if (activeMethod === 'pse') {
                    console.log('üîç Validando campos de PSE...');
                    
                    // Validar informaci√≥n de pago PSE
                    const pseBankEl = document.getElementById('pseBank');
                    const pseDocumentTypeEl = document.getElementById('pseDocumentType');
                    const pseDocumentNumberEl = document.getElementById('pseDocumentNumber');
                    const pseEmailEl = document.getElementById('pseEmail');
                    
                    console.log('üè¶ Estado del banco:', pseBankEl?.value || 'NO SELECCIONADO');
                    if (!pseBankEl || !pseBankEl.value) {
                        this.showAlert('Selecciona tu banco', 'error');
                        if (pseBankEl) pseBankEl.focus();
                        return false;
                    }
                    
                    console.log('üìÑ Tipo de documento:', pseDocumentTypeEl?.value || 'NO SELECCIONADO');
                    if (!pseDocumentTypeEl || !pseDocumentTypeEl.value) {
                        this.showAlert('Selecciona el tipo de documento', 'error');
                        if (pseDocumentTypeEl) pseDocumentTypeEl.focus();
                        return false;
                    }
                    
                    console.log('üî¢ N√∫mero de documento:', pseDocumentNumberEl?.value || 'VAC√çO');
                    if (!pseDocumentNumberEl || !pseDocumentNumberEl.value.trim()) {
                        this.showAlert('Ingresa tu n√∫mero de documento', 'error');
                        if (pseDocumentNumberEl) pseDocumentNumberEl.focus();
                        return false;
                    }
                    
                    console.log('üìß Email:', pseEmailEl?.value || 'VAC√çO');
                    if (!pseEmailEl || !pseEmailEl.value.trim()) {
                        this.showAlert('Ingresa tu correo electr√≥nico', 'error');
                        if (pseEmailEl) pseEmailEl.focus();
                        return false;
                    }
                    
                    // Validar formato de email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(pseEmailEl.value.trim())) {
                        this.showAlert('Ingresa un email v√°lido', 'error');
                        pseEmailEl.focus();
                        return false;
                    }
                    
                    console.log('‚úÖ Validaci√≥n de pago PSE exitosa, validando env√≠o...');
                    
                    // Validar informaci√≥n de env√≠o PSE (usar campos comunes de env√≠o)
                    const pseFullNameEl = document.getElementById('fullName');
                    const psePhoneEl = document.getElementById('phone');
                    const pseAddressEl = document.getElementById('address');
                    const pseCityEl = document.getElementById('city');
                    const pseDepartmentEl = document.getElementById('department');
                    
                    console.log('üë§ Nombre completo:', pseFullNameEl?.value || 'VAC√çO');
                    if (!pseFullNameEl || !pseFullNameEl.value.trim()) {
                        this.showAlert('Ingresa tu nombre completo', 'error');
                        if (pseFullNameEl) pseFullNameEl.focus();
                        return false;
                    }
                    
                    console.log('üì± Tel√©fono:', psePhoneEl?.value || 'VAC√çO');
                    if (!psePhoneEl || !psePhoneEl.value.trim()) {
                        this.showAlert('Ingresa tu tel√©fono', 'error');
                        if (psePhoneEl) psePhoneEl.focus();
                        return false;
                    }
                    
                    console.log('üè† Direcci√≥n:', pseAddressEl?.value || 'VAC√çO');
                    if (!pseAddressEl || !pseAddressEl.value.trim()) {
                        this.showAlert('Ingresa tu direcci√≥n completa', 'error');
                        if (pseAddressEl) pseAddressEl.focus();
                        return false;
                    }
                    
                    console.log('üèôÔ∏è Ciudad:', pseCityEl?.value || 'NO SELECCIONADA');
                    if (!pseCityEl || !pseCityEl.value) {
                        this.showAlert('Selecciona tu ciudad', 'error');
                        if (pseCityEl) pseCityEl.focus();
                        return false;
                    }
                    
                    console.log('üó∫Ô∏è Departamento:', pseDepartmentEl?.value || 'NO SELECCIONADO');
                    if (!pseDepartmentEl || !pseDepartmentEl.value) {
                        this.showAlert('Selecciona tu departamento', 'error');
                        if (pseDepartmentEl) pseDepartmentEl.focus();
                        return false;
                    }
                    
                    console.log('‚úÖ Validaci√≥n de PSE completamente exitosa - Todos los campos OK');
                } else {
                    console.log('‚úÖ M√©todo no requiere validaci√≥n especial:', activeMethod);
                    
                    // Solo validar formulario de env√≠o para m√©todos que NO sean MercadoPago ni PSE
                    if (activeMethod !== 'mercadopago' && activeMethod !== 'card' && activeMethod !== 'credit_card' && activeMethod !== 'debit_card' && activeMethod !== 'pse') {
                        console.log('üöö Validando datos de env√≠o...');
                        if (!this.validateShippingForm()) {
                            return false;
                        }
                    } else {
                        console.log('üéØ MercadoPago seleccionado - Saltando validaci√≥n de env√≠o (se maneja en la plataforma)');
                    }
                }
                
                console.log('‚úÖ Validaci√≥n exitosa');
                return true;
            }

            validateShippingForm() {
                const requiredFields = [
                    { id: 'fullName', label: 'nombre completo del destinatario' },
                    { id: 'phone', label: 'tel√©fono' },
                    { id: 'idNumber', label: 'n√∫mero de identificaci√≥n' },
                    { id: 'address', label: 'direcci√≥n' },
                    { id: 'city', label: 'ciudad' },
                    { id: 'department', label: 'departamento' }
                ];

                for (const field of requiredFields) {
                    const element = document.getElementById(field.id);
                    const value = element?.value?.trim();
                    
                    if (!value) {
                        console.log(`‚ùå Campo requerido faltante: ${field.id}`);
                        this.showAlert(`Por favor completa el campo: ${field.label}`, 'error');
                        if (element) {
                            element.focus();
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return false;
                    }
                }

                // Validar formato de tel√©fono (b√°sico)
                const phone = document.getElementById('phone')?.value?.trim();
                if (phone && !/^[\d\s\-\+\(\)]{7,15}$/.test(phone)) {
                    console.log('‚ùå Formato de tel√©fono inv√°lido:', phone);
                    this.showAlert('Ingresa un n√∫mero de tel√©fono v√°lido', 'error');
                    document.getElementById('phone')?.focus();
                    return false;
                }

                // Validar n√∫mero de identificaci√≥n
                const idNumber = document.getElementById('idNumber')?.value?.trim();
                if (idNumber && !/^\d{5,15}$/.test(idNumber)) {
                    console.log('‚ùå N√∫mero de identificaci√≥n inv√°lido:', idNumber);
                    this.showAlert('Ingresa un n√∫mero de identificaci√≥n v√°lido (solo n√∫meros)', 'error');
                    document.getElementById('idNumber')?.focus();
                    return false;
                }

                console.log('‚úÖ Datos de env√≠o v√°lidos');
                return true;
            }

            setupShippingFormEnhancements() {
                // Autocompletar n√∫mero de identificaci√≥n si est√° en el formulario de pago
                const documentNumberField = document.getElementById('documentNumber');
                const shippingIdField = document.getElementById('idNumber');
                
                if (documentNumberField && shippingIdField) {
                    documentNumberField.addEventListener('blur', () => {
                        if (!shippingIdField.value && documentNumberField.value) {
                            shippingIdField.value = documentNumberField.value;
                        }
                    });
                }

                // Autocompletar nombre completo desde titular de tarjeta
                const cardHolderField = document.getElementById('cardHolder');
                const fullNameField = document.getElementById('fullName');
                
                if (cardHolderField && fullNameField) {
                    cardHolderField.addEventListener('blur', () => {
                        if (!fullNameField.value && cardHolderField.value) {
                            fullNameField.value = cardHolderField.value;
                        }
                    });
                }

                // Mapeo autom√°tico ciudad-departamento
                const cityField = document.getElementById('city');
                const departmentField = document.getElementById('department');
                
                if (cityField && departmentField) {
                    const cityToDepartment = {
                        'bogota': 'cundinamarca',
                        'medellin': 'antioquia',
                        'cali': 'valle',
                        'barranquilla': 'atlantico',
                        'cartagena': 'bolivar',
                        'bucaramanga': 'santander',
                        'cucuta': 'norte_santander',
                        'pereira': 'risaralda',
                        'ibague': 'tolima',
                        'santa_marta': 'magdalena',
                        'villavicencio': 'meta',
                        'manizales': 'caldas',
                        'neiva': 'huila'
                    };

                    cityField.addEventListener('change', () => {
                        const selectedCity = cityField.value;
                        if (cityToDepartment[selectedCity] && !departmentField.value) {
                            departmentField.value = cityToDepartment[selectedCity];
                        }
                    });
                }
            }

            async saveOrderToDatabase(paymentResult, paymentData) {
                try {
                    console.log('üíæ Guardando pedido en la base de datos...');
                    
                    const shippingData = this.getShippingData();
                    
                    // Preparar datos para la API de guardado
                    const orderData = {
                        pago_exitoso: true,
                        carrito: this.cart.map(item => ({
                            nombre: item.nombre || item.name,
                            precio: parseFloat(item.precio || item.price),
                            cantidad: parseInt(item.cantidad || item.quantity),
                            imagen: item.imagen || item.image,
                            talla: item.talla || item.size,
                            color: item.color
                        })),
                        envio: {
                            nombre_completo: shippingData.nombre_completo,
                            email: shippingData.email,
                            telefono: shippingData.telefono,
                            departamento: shippingData.departamento,
                            ciudad: shippingData.ciudad,
                            direccion: shippingData.direccion,
                            codigo_postal: shippingData.codigo_postal,
                            notas_adicionales: shippingData.notas_adicionales
                        },
                        subtotal: this.calculateSubtotal(),
                        costo_envio: 0, // ENV√çO GRATIS
                        total: this.calculateTotal(),
                        metodo_pago: 'mercadopago',
                        datos_pago: {
                            transaction_id: paymentResult.id || paymentResult.payment_id,
                            status: paymentResult.status,
                            payment_method: paymentResult.payment_method_id || 'unknown',
                            amount: paymentResult.transaction_amount || this.calculateTotal(),
                            currency: 'COP',
                            timestamp: new Date().toISOString()
                        }
                    };

                    console.log('üì¶ Datos del pedido:', orderData);
                    console.log('üîç VERIFICACI√ìN ESPEC√çFICA DE CAMPOS:');
                    console.log('- pago_exitoso:', orderData.pago_exitoso);
                    console.log('- carrito.length:', orderData.carrito?.length);
                    console.log('- carrito:', orderData.carrito);
                    console.log('- envio.nombre_completo:', orderData.envio?.nombre_completo);
                    console.log('- envio.email:', orderData.envio?.email);
                    console.log('- envio.telefono:', orderData.envio?.telefono);
                    console.log('- envio.departamento:', orderData.envio?.departamento);
                    console.log('- envio.ciudad:', orderData.envio?.ciudad);
                    console.log('- envio.direccion:', orderData.envio?.direccion);
                    console.log('- subtotal:', orderData.subtotal);
                    console.log('- costo_envio:', orderData.costo_envio);
                    console.log('- total:', orderData.total);

                    // Usar archivo real para guardar en BD (tanto sandbox como producci√≥n)
                    const saveEndpoint = 'api/guardar-pedido-real.php';

                    // Enviar a la API
                    const response = await fetch(saveEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData)
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('‚úÖ Pedido guardado exitosamente:', result.pedido_id);
                        
                        // Limpiar carrito despu√©s de guardar exitosamente
                        this.clearCart();
                        
                        return {
                            success: true,
                            pedido_id: result.pedido_id,
                            message: 'Pedido guardado exitosamente'
                        };
                    } else {
                        throw new Error(result.message || 'Error guardando pedido');
                    }

                } catch (error) {
                    console.error('‚ùå Error guardando pedido:', error);
                    
                    // No fallar completamente si hay error en el guardado
                    // El pago ya fue exitoso
                    return {
                        success: false,
                        error: error.message,
                        message: 'Pago exitoso, pero hubo un problema guardando los datos'
                    };
                }
            }

            clearCart() {
                this.cart = [];
                localStorage.removeItem('cart');
                console.log('üóëÔ∏è Carrito limpiado');
            }

            preparePaymentData() {
                const items = this.cart.map(item => ({
                    title: item.nombre || item.name || 'Producto',
                    unit_price: parseFloat(item.precio || item.price || 0),
                    quantity: parseInt(item.cantidad || item.quantity || 1),
                    currency_id: 'COP'
                }));

                // Agregar env√≠o como item
                items.push({
                    title: 'Env√≠o',
                    unit_price: 0, // ENV√çO GRATIS
                    quantity: 1,
                    currency_id: 'COP'
                });

                return {
                    items: items,
                    back_urls: {
                        success: window.location.origin + '/Musa/success-premium.html',
                        failure: window.location.origin + '/Musa/failure-premium.html',
                        pending: window.location.origin + '/Musa/pending-premium.html'
                    },
                    payment_methods: {
                        excluded_payment_methods: [],
                        excluded_payment_types: [],
                        installments: 12
                    },
                    external_reference: 'MUSA-' + Date.now(),
                    statement_descriptor: 'MUSA FASHION'
                };
            }

            async createPreference(paymentData) {
                try {
                    console.log('üì° Enviando datos a API:', paymentData);
                    
                    // Determinar qu√© endpoint usar seg√∫n el m√©todo de pago
                    const isPSE = paymentData.additional_info?.payment_method === 'pse';
                    const endpoint = isPSE ? 'api/create-preference-pse-production.php' : 'api/create-preference-premium.php';
                    
                    if (isPSE) {
                        const envMode = this.config?.environment || 'unknown';
                        console.log(`üè¶ Usando endpoint PSE en modo ${envMode.toUpperCase()} (${envMode === 'test' ? 'pagos de prueba' : 'pagos reales'})`);
                    }
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(paymentData)
                    });
                    
                    console.log('üì° Respuesta del servidor:', response.status, response.statusText);
                    
                    // Intentar obtener el JSON incluso si la respuesta no es "ok"
                    let result;
                    try {
                        result = await response.json();
                        console.log('üì° Datos recibidos:', result);
                    } catch (jsonError) {
                        console.error('‚ùå Error parsing JSON:', jsonError);
                        throw new Error('Respuesta del servidor inv√°lida');
                    }
                    
                    // Si hay error en el resultado pero es una respuesta simulada v√°lida
                    if (result.error && !result.success) {
                        throw new Error(result.message || 'Error creando preferencia');
                    }
                    
                    // Si es una respuesta exitosa (real o simulada)
                    if (result.success || result.init_point) {
                        console.log('‚úÖ Preferencia creada exitosamente');
                        return result;
                    }
                    
                    // Si llegamos aqu√≠, algo sali√≥ mal
                    throw new Error('Respuesta inesperada del servidor');
                    
                } catch (error) {
                    console.error('‚ùå Error creando preferencia:', error);
                    throw error;
                }
            }

            setLoadingState(loading) {
                const button = document.getElementById('payButton');
                const spinner = button.querySelector('.loading-spinner');
                
                if (loading) {
                    button.classList.add('loading');
                    button.disabled = true;
                    button.innerHTML = '<div class="loading-spinner"></div> Procesando...';
                } else {
                    button.classList.remove('loading');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-lock"></i> Pagar con MercadoPago';
                }
            }

            updatePayButton(text, isLoading = false) {
                const button = document.getElementById('payButton');
                if (button) {
                    if (isLoading) {
                        button.classList.add('loading');
                        button.disabled = true;
                        button.innerHTML = `<div class="loading-spinner"></div> ${text}`;
                        console.log('üí≥ Bot√≥n de pago actualizado (cargando):', text);
                    } else {
                        button.classList.remove('loading');
                        button.disabled = false;
                        button.innerHTML = `<i class="fas fa-lock"></i> ${text}`;
                        console.log('üí≥ Bot√≥n de pago actualizado:', text);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Bot√≥n de pago no encontrado para actualizar');
                }
            }

            showAlert(message, type = 'info') {
                const container = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} fade-in`;
                alert.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    ${message}
                `;
                
                container.appendChild(alert);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }

            formatCurrency(amount) {
                const numAmount = parseFloat(amount) || 0;
                return new Intl.NumberFormat('es-CO').format(numAmount);
            }

            // üîç FUNCIONES DE DEBUG Y DIAGN√ìSTICO
            debugSystem() {
                console.log('üîç === DEBUG COMPLETO DEL SISTEMA DE PAGO ===');
                
                // üìä Estado del sistema
                console.log('ÔøΩ Estado del Sistema:', {
                    sdkCargado: typeof window.MercadoPago !== 'undefined',
                    instanciaMP: !!this.mp,
                    configuracion: this.config || 'No configurado',
                    carrito: this.cart,
                    total: this.total,
                    procesando: this.isProcessing
                });
                
                // üìã Estado de formularios
                const cardForm = document.getElementById('mp-card-form');
                const pseForm = document.getElementById('pse-form');
                const activeTab = document.querySelector('.method-tab.active');
                
                console.log('üìã Estado de Formularios:', {
                    tarjeta: !!cardForm,
                    pse: !!pseForm,
                    metodoActivo: activeTab?.dataset?.method || 'ninguno'
                });
                
                // üéØ Elementos DOM cr√≠ticos
                const elements = {
                    'orderItems': document.getElementById('orderItems'),
                    'payButton': document.getElementById('payButton'),
                    'cardForm': document.getElementById('cardForm'),
                    'alertContainer': document.getElementById('alertContainer'),
                    'totalAmount': document.getElementById('totalAmount'),
                    'subtotalAmount': document.getElementById('subtotalAmount')
                };
                
                console.log('üéØ Elementos DOM:');
                Object.entries(elements).forEach(([name, element]) => {
                    console.log(`  - ${name}:`, element ? '‚úÖ Encontrado' : '‚ùå NO ENCONTRADO');
                });
                
                // üåê Verificar conectividad API
                console.log('üåê Verificando conectividad API...');
                fetch('api/process-payment.php', {
                    method: 'GET'
                }).then(response => {
                    console.log('üì° API Status:', {
                        status: response.status,
                        statusText: response.statusText,
                        url: response.url
                    });
                }).catch(error => {
                    console.error('‚ùå API Error:', error.message);
                });
                
                // üíæ localStorage
                console.log('üíæ localStorage Data:', {
                    carrito: localStorage.getItem('carrito'),
                    psePendientes: localStorage.getItem('pse_pending_payments')
                });
                
                return {
                    cart: this.cart,
                    total: this.total,
                    mercadoPago: !!this.mp,
                    config: this.config,
                    elements: elements
                };
            }

            // üîß FUNCI√ìN DE PRUEBA PARA AGREGAR PRODUCTOS FAKE
            addTestProducts() {
                const testCart = [
                    {
                        id: 'test-1',
                        name: 'Producto de Prueba 1',
                        price: 50000,
                        quantity: 1,
                        color: 'Azul',
                        size: 'M',
                        image: 'https://via.placeholder.com/60x60/007bff/fff?text=P1'
                    },
                    {
                        id: 'test-2',
                        name: 'Producto de Prueba 2',
                        price: 75000,
                        quantity: 2,
                        color: 'Rojo',
                        size: 'L',
                        image: 'https://via.placeholder.com/60x60/dc3545/fff?text=P2'
                    }
                ];
                
                localStorage.setItem('carrito', JSON.stringify(testCart));
                console.log('‚úÖ Productos de prueba agregados al localStorage');
                console.log('üîÑ Recarga la p√°gina para ver los productos');
                
                return testCart;
            }
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM Cargado - Inicializando Sistema de Pago Premium...');
            
            try {
                window.paymentSystem = new PremiumPaymentSystem();
                
                // Agregar referencia global para iframe PSE
                window.paymentProcessor = window.paymentSystem;
                
                // Agregar funciones globales de debug
                window.debugPayment = () => window.paymentSystem.debugSystem();
                window.addTestProducts = () => window.paymentSystem.addTestProducts();
                
                console.log('‚úÖ Sistema inicializado. Comandos disponibles:');
                console.log('  - debugPayment(): Ver estado del sistema');
                console.log('  - addTestProducts(): Agregar productos de prueba');
                
            } catch (error) {
                console.error('‚ùå Error inicializando sistema:', error);
                
                // Mostrar error en la p√°gina
                const alertContainer = document.getElementById('alertContainer');
                if (alertContainer) {
                    alertContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle"></i> Error del Sistema</h5>
                            <p>Error inicializando el sistema de pago: ${error.message}</p>
                            <button class="btn btn-outline-danger btn-sm" onclick="location.reload()">
                                Recargar P√°gina
                            </button>
                        </div>
                    `;
                }
            }
        });

        // Agregar animaciones de entrada
        window.addEventListener('load', () => {
            document.querySelectorAll('.slide-up').forEach((element, index) => {
                setTimeout(() => {
                    element.style.animation = 'slideUp 0.6s ease-out forwards';
                }, index * 100);
            });
            
            // üîç DEBUGGING TABS DESPU√âS DE CARGAR
            setTimeout(() => {
                console.log('‚úÖ Tabs configurados');
                
                const methodTabs = document.querySelectorAll('.method-tab');
                
                methodTabs.forEach((tab, index) => {
                    // Forzar que sean clickeables
                    tab.style.pointerEvents = 'auto';
                    tab.style.cursor = 'pointer';
                });
            }, 2000);
        });

        // Funci√≥n global para abrir WhatsApp con mensaje
        window.openWhatsApp = function(message) {
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/573232212316?text=${encodedMessage}`;
            console.log('üü¢ Abriendo WhatsApp con mensaje:', message.substring(0, 100) + '...');
            window.open(whatsappURL, '_blank');
        };

        // üîß FUNCI√ìN GLOBAL PARA FORZAR EVENTO EN TABS 
        window.setupTabsManually = function() {
            console.log('üîß Configurando tabs manualmente...');
            
            const methodTabs = document.querySelectorAll('.method-tab');
            console.log('üéØ Tabs encontradas:', methodTabs.length);
            
            methodTabs.forEach((tab, index) => {
                console.log(`üîß Configurando tab manual ${index + 1}:`, tab.dataset.method);
                
                // Limpiar eventos anteriores
                tab.replaceWith(tab.cloneNode(true));
                
                // Obtener el tab reci√©n creado
                const newTab = document.querySelectorAll('.method-tab')[index];
                
                // Configurar propiedades
                newTab.style.cursor = 'pointer';
                newTab.style.pointerEvents = 'auto';
                newTab.style.zIndex = '1000';
                
                // Agregar evento
                newTab.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('ÔøΩ Cambiando a:', newTab.dataset.method);
                    
                    // Remover active de todos
                    document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
                    
                    // Agregar active al clickeado
                    newTab.classList.add('active');
                    
                    // Si existe el sistema de pago, usarlo
                    if (window.paymentProcessor && window.paymentProcessor.handlePaymentMethodChange) {
                        window.paymentProcessor.handlePaymentMethodChange(newTab.dataset.method);
                    }
                });
                
                console.log(`‚úÖ Tab ${index + 1} configurado manualmente`);
            });
            
            console.log('‚úÖ Todos los tabs configurados manualmente');
        };

        // üö® EJECUTAR CONFIGURACI√ìN MANUAL DESPU√âS DE TODO
        setTimeout(() => {
            window.setupTabsManually();
        }, 3000);

        // Agregar event listener para detecci√≥n autom√°tica de tipo de tarjeta
        document.addEventListener('DOMContentLoaded', function() {
            // Buscar el campo de n√∫mero de tarjeta cada vez que se carga el formulario
            const checkForCardNumber = () => {
                const cardNumberField = document.getElementById('cardNumber');
                if (cardNumberField && !cardNumberField.hasAttribute('data-listener-added')) {
                    cardNumberField.setAttribute('data-listener-added', 'true');
                    cardNumberField.addEventListener('input', function(e) {
                        if (window.paymentProcessor) {
                            window.paymentProcessor.validateCard(e.target.value);
                        }
                    });
                }
            };

            // Verificar inmediatamente y luego cada segundo
            checkForCardNumber();
            setInterval(checkForCardNumber, 1000);

            // Initialize Bank Selector
            initializeBankSelector();
        });

        // Bank Selector Functionality
        function initializeBankSelector() {
            const bankOptions = document.querySelectorAll('.bank-option');
            const pseBank = document.getElementById('pseBank');
            const selectedBankInfo = document.getElementById('selectedBankInfo');
            const selectedBankName = document.getElementById('selectedBankName');

            bankOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remover selecci√≥n previa
                    bankOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Agregar selecci√≥n a la opci√≥n actual
                    this.classList.add('selected');
                    
                    // Obtener el valor y nombre del banco
                    const bankValue = this.getAttribute('data-value');
                    const bankName = this.querySelector('.bank-name').textContent;
                    
                    // Actualizar el campo oculto
                    pseBank.value = bankValue;
                    
                    // Mostrar informaci√≥n del banco seleccionado
                    selectedBankName.textContent = bankName;
                    selectedBankInfo.style.display = 'block';
                    
                    // Agregar animaci√≥n
                    selectedBankInfo.style.opacity = '0';
                    setTimeout(() => {
                        selectedBankInfo.style.opacity = '1';
                    }, 100);

                    // Trigger change event for validation
                    pseBank.dispatchEvent(new Event('change'));
                });
            });

            // Reset selector when form is reset
            const pseForm = document.getElementById('psePaymentForm');
            if (pseForm) {
                pseForm.addEventListener('reset', function() {
                    bankOptions.forEach(opt => opt.classList.remove('selected'));
                    selectedBankInfo.style.display = 'none';
                    pseBank.value = '';
                });
            }
        }

        // Verificar y procesar pago PSE pendiente desde localStorage
        function checkPendingPSEPayment() {
            console.log('üîç Verificando pagos PSE pendientes en localStorage...');
            
            const pseResult = localStorage.getItem('pse_payment_result');
            if (pseResult) {
                try {
                    const data = JSON.parse(pseResult);
                    console.log('üì¶ Datos PSE encontrados en localStorage:', data);
                    
                    // Verificar que no sean muy antiguos (max 10 minutos)
                    const ageMinutes = (Date.now() - data.timestamp) / (1000 * 60);
                    console.log('‚è±Ô∏è Antig√ºedad del pago PSE:', ageMinutes.toFixed(2), 'minutos');
                    
                    if (ageMinutes < 10 && data.status === 'approved') {
                        console.log('‚úÖ Procesando pago PSE pendiente...');
                        
                        // Limpiar localStorage
                        localStorage.removeItem('pse_payment_result');
                        
                        // Procesar el pago
                        showPSESuccessModal(data.payment_id, data.external_reference);
                        return true;
                    } else {
                        console.log('‚è≥ Pago PSE demasiado antiguo o inv√°lido, eliminando...');
                        localStorage.removeItem('pse_payment_result');
                    }
                } catch (error) {
                    console.error('‚ùå Error procesando datos PSE desde localStorage:', error);
                    localStorage.removeItem('pse_payment_result');
                }
            } else {
                console.log('‚ÑπÔ∏è No hay pagos PSE pendientes en localStorage');
            }
            return false;
        }

        // Manejar retorno de PSE
        function handlePSEReturn() {
            console.log('üîç Verificando par√°metros de URL para retorno PSE...');
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const paymentId = urlParams.get('payment_id');
            const externalReference = urlParams.get('external_reference');

            console.log('üìã Par√°metros de URL encontrados:', {
                status: status,
                paymentId: paymentId,
                externalReference: externalReference,
                allParams: Object.fromEntries(urlParams.entries())
            });

            if (status && paymentId) {
                console.log('üè¶ Retorno de PSE detectado y v√°lido:', { status, paymentId, externalReference });
                
                switch(status) {
                    case 'approved':
                        console.log('‚úÖ Estado APROBADO - llamando showPSESuccessModal');
                        showPSESuccessModal(paymentId, externalReference);
                        break;
                    case 'pending':
                        console.log('‚è≥ Estado PENDIENTE - llamando showPSEPendingModal');
                        showPSEPendingModal(paymentId, externalReference);
                        break;
                    case 'rejected':
                        console.log('‚ùå Estado RECHAZADO - llamando showPSEErrorModal');
                        showPSEErrorModal('El pago fue rechazado por el banco');
                        break;
                    default:
                        console.log('‚ùì Estado PSE no reconocido:', status);
                }
                
                // Limpiar URL sin recargar la p√°gina
                console.log('üßπ Limpiando URL...');
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                return true;
            } else {
                console.log('‚ÑπÔ∏è No se detectaron par√°metros de retorno PSE v√°lidos');
                return false;
            }
        }

        function showPSESuccessModal(paymentId, externalReference) {
            console.log('üéØ Iniciando showPSESuccessModal con:', { paymentId, externalReference });
            
            // Guardar pedido en la base de datos
            savePSEOrder(paymentId, externalReference).then((result) => {
                console.log('‚úÖ Pedido PSE guardado exitosamente:', result);
                Swal.fire({
                    title: 'üéâ ¬°Pago PSE Exitoso!',
                    html: `
                        <div class="pse-success-content">
                            <div class="success-icon">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 80px; margin-bottom: 20px;"></i>
                            </div>
                            <h4>Tu pago ha sido procesado correctamente</h4>
                            <div class="payment-details" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                                <h6><strong>Detalles de la Transacci√≥n:</strong></h6>
                                <p><strong>M√©todo:</strong> PSE - Pagos Seguros en L√≠nea</p>
                                <p><strong>ID de Pago:</strong> ${paymentId}</p>
                                <p><strong>Referencia:</strong> ${externalReference || 'N/A'}</p>
                                <p><strong>Pedido ID:</strong> ${result.pedido_id || 'N/A'}</p>
                                <p><strong>Estado:</strong> <span style="color: #28a745;">APROBADO</span></p>
                                <p><strong>Fecha:</strong> ${new Date().toLocaleString('es-CO')}</p>
                                <p><strong>Modo:</strong> <span style="color: #007bff; font-weight: bold;">PRODUCCI√ìN</span></p>
                            </div>
                            <div class="next-steps" style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-top: 20px;">
                                <h6><i class="fas fa-info-circle"></i> ¬øQu√© sigue?</h6>
                                <ul style="text-align: left; margin: 10px 0;">
                                    <li>Tu pedido ha sido registrado en nuestro sistema</li>
                                    <li>Recibir√°s un email de confirmaci√≥n</li>
                                    <li>Tu pedido ser√° procesado en 24-48 horas</li>
                                    <li>Te contactaremos para coordinar el env√≠o</li>
                                    <li><strong>El pago fue procesado de forma real</strong></li>
                                </ul>
                            </div>
                        </div>
                    `,
                    icon: 'success',
                    confirmButtonText: '‚úÖ Continuar',
                    confirmButtonColor: '#28a745',
                    allowOutsideClick: false,
                    customClass: {
                        popup: 'pse-success-modal'
                    }
                }).then(() => {
                    console.log('‚úÖ Pago PSE completado exitosamente y guardado en BD');
                    // Limpiar carrito
                    localStorage.removeItem('cart');
                    // Opcional: redirigir a p√°gina principal
                    // window.location.href = 'index.html';
                });
            }).catch((error) => {
                console.error('‚ùå Error guardando pedido PSE:', error);
                // Mostrar modal de √©xito pero con advertencia sobre el guardado
                Swal.fire({
                    title: 'üéâ Pago Exitoso',
                    html: `
                        <div class="pse-success-content">
                            <div class="success-icon">
                                <i class="fas fa-check-circle" style="color: #28a745; font-size: 80px; margin-bottom: 20px;"></i>
                            </div>
                            <h4>Tu pago ha sido procesado correctamente</h4>
                            <div class="payment-details" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                                <h6><strong>Detalles de la Transacci√≥n:</strong></h6>
                                <p><strong>ID de Pago:</strong> ${paymentId}</p>
                                <p><strong>Estado:</strong> <span style="color: #28a745;">APROBADO</span></p>
                            </div>
                            <div class="alert alert-warning" style="margin-top: 15px;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Nota:</strong> Tu pago fue exitoso. Te contactaremos por email para confirmar tu pedido.
                                <br><small>Error t√©cnico: ${error.message}</small>
                            </div>
                        </div>
                    `,
                    icon: 'success',
                    confirmButtonText: '‚úÖ Continuar',
                    confirmButtonColor: '#28a745'
                });
            });
        }

        async function savePSEOrder(paymentId, externalReference) {
            try {
                console.log('üîÑ Iniciando savePSEOrder PRODUCCI√ìN con:', { paymentId, externalReference });
                
                // Obtener datos del carrito
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                console.log('üì¶ Carrito obtenido:', cart);
                
                // Validar que hay productos (en producci√≥n debe haber carrito real)
                if (cart.length === 0) {
                    throw new Error('No hay productos en el carrito para procesar el pago PSE');
                }

                // Obtener datos de env√≠o del formulario PSE (deben estar completos)
                const pseData = {
                    nombre_completo: document.getElementById('pseFullName')?.value,
                    email: document.getElementById('pseEmail')?.value,
                    telefono: document.getElementById('psePhone')?.value,
                    departamento: document.getElementById('pseDepartment')?.value,
                    ciudad: document.getElementById('pseCity')?.value,
                    direccion: document.getElementById('pseAddress')?.value,
                    codigo_postal: document.getElementById('psePostalCode')?.value || '',
                    notas_adicionales: document.getElementById('pseDeliveryNotes')?.value || ''
                };
                
                console.log('üìã Datos PSE del formulario:', pseData);

                // Validar datos requeridos (ESTRICTO en producci√≥n)
                const requiredPSEFields = ['nombre_completo', 'email', 'telefono', 'departamento', 'ciudad', 'direccion'];
                for (const field of requiredPSEFields) {
                    if (!pseData[field]) {
                        console.error(`‚ùå Campo requerido faltante: ${field}`, pseData[field]);
                        throw new Error(`Por favor completa el campo: ${field}`);
                    }
                }
                
                console.log('‚úÖ PSE PRODUCCI√ìN - Validaci√≥n de campos completada');

                // Validar datos requeridos
                const requiredFields = ['nombre_completo', 'email', 'telefono', 'departamento', 'ciudad', 'direccion'];
                for (const field of requiredFields) {
                    if (!pseData[field]) {
                        console.error(`‚ùå Campo requerido faltante: ${field}`, pseData[field]);
                        throw new Error(`Campo requerido faltante: ${field}`);
                    }
                }
                
                console.log('‚úÖ Validaci√≥n de campos completada');

                // Calcular totales
                const subtotal = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                const costo_envio = 0; // Env√≠o gratis
                const total = subtotal + costo_envio;
                
                console.log('üí∞ Totales calculados:', { subtotal, costo_envio, total });

                // Preparar datos del pedido (ESTRUCTURA CORREGIDA PARA COMPATIBILIDAD)
                const orderData = {
                    carrito: cart, // Cambiar de 'productos' a 'carrito' para compatibilidad con PHP
                    subtotal: subtotal,
                    costo_envio: costo_envio,
                    total: total,
                    envio: pseData,
                    payment_id: paymentId,
                    external_reference: externalReference,
                    metodo_pago: 'pse',
                    pago_exitoso: true,
                    datos_pago: {
                        payment_id: paymentId,
                        external_reference: externalReference,
                        banco: document.getElementById('pseBank')?.value || 'bancolombia',
                        tipo_documento: document.getElementById('pseDocumentType')?.value,
                        numero_documento: document.getElementById('pseDocumentNumber')?.value,
                        fecha_pago: new Date().toISOString()
                    }
                };

                console.log('üíæ Datos del pedido preparados:', orderData);

                // Enviar al servidor
                console.log('üì° Enviando pedido al servidor...');
                const response = await fetch('api/guardar-pedido-real.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });

                console.log('üì° Respuesta del servidor:', response.status, response.statusText);
                
                const result = await response.json();
                console.log('üì¶ Datos de respuesta:', result);

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Error guardando pedido');
                }

                console.log('‚úÖ Pedido PSE guardado exitosamente:', result.pedido_id);
                return result;

            } catch (error) {
                console.error('‚ùå Error en savePSEOrder:', error);
                console.error('üìç Stack trace:', error.stack);
                throw error;
            }
        }

        function showPSEPendingModal(paymentId, externalReference) {
            Swal.fire({
                title: '‚è≥ Pago PSE Pendiente',
                html: `
                    <div class="pse-pending-content">
                        <div class="pending-icon">
                            <i class="fas fa-clock" style="color: #ffc107; font-size: 80px; margin-bottom: 20px;"></i>
                        </div>
                        <h4>Tu pago est√° siendo procesado</h4>
                        <div class="payment-details" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                            <h6><strong>Detalles de la Transacci√≥n:</strong></h6>
                            <p><strong>ID de Pago:</strong> ${paymentId}</p>
                            <p><strong>Estado:</strong> <span style="color: #ffc107;">PENDIENTE</span></p>
                            <p><strong>Fecha:</strong> ${new Date().toLocaleString('es-CO')}</p>
                        </div>
                        <p>El banco est√° procesando tu transacci√≥n. Recibir√°s una confirmaci√≥n por email una vez que se complete.</p>
                    </div>
                `,
                icon: 'warning',
                confirmButtonText: 'üëç Entendido',
                confirmButtonColor: '#ffc107'
            });
        }

        function showPSEErrorModal(message) {
            Swal.fire({
                title: '‚ùå Error en el Pago PSE',
                html: `
                    <div class="pse-error-content">
                        <div class="error-icon">
                            <i class="fas fa-times-circle" style="color: #dc3545; font-size: 80px; margin-bottom: 20px;"></i>
                        </div>
                        <h4>No se pudo procesar el pago</h4>
                        <p>${message}</p>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <h6><i class="fas fa-lightbulb"></i> ¬øQu√© puedes hacer?</h6>
                            <ul style="text-align: left; margin: 10px 0;">
                                <li>Verifica que tengas fondos suficientes</li>
                                <li>Intenta con otro m√©todo de pago</li>
                                <li>Contacta a tu banco si el problema persiste</li>
                            </ul>
                        </div>
                    </div>
                `,
                icon: 'error',
                confirmButtonText: 'üîÑ Intentar de nuevo',
                confirmButtonColor: '#dc3545'
            });
        }

        // Ejecutar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ P√°gina cargada - verificando PSE...');
            
            // Primero verificar par√°metros de URL
            const urlProcessed = handlePSEReturn();
            
            // Si no hay par√°metros en URL, verificar localStorage
            if (!urlProcessed) {
                console.log('üîÑ No hay par√°metros PSE en URL, verificando localStorage...');
                checkPendingPSEPayment();
            }
            
            // Mostrar modo de configuraci√≥n basado en el entorno detectado
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const mode = isLocalhost ? 'TEST' : 'PRODUCCI√ìN';
            const paymentType = isLocalhost ? 'pagos de prueba' : 'pagos reales';
            console.log(`üè¶ PSE configurado en modo ${mode} - ${paymentType} habilitados`);
        });
    </script>
</body>
</html>