<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Flujo de Pago - MercadoPago</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3><i class="bi bi-credit-card me-2"></i>üß™ Prueba de Pago - MercadoPago</h3>
                    </div>
                    <div class="card-body">
                        
                        <!-- Datos de Prueba -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-credit-card me-2"></i>üí≥ Tarjetas de Prueba:</h6>
                                    <ul class="mb-2">
                                        <li><strong>VISA:</strong> 4170 0688 1010 8020</li>
                                        <li><strong>MasterCard:</strong> 5031 7557 3453 0604</li>
                                        <li><strong>American Express:</strong> 3711 8030 3257 522</li>
                                    </ul>
                                    <small><strong>CVV:</strong> 123 | <strong>Fecha:</strong> 12/25</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-success">
                                    <h6><i class="bi bi-person me-2"></i>üë§ Datos del Titular:</h6>
                                    <ul class="mb-2">
                                        <li><strong>Nombre:</strong> APRO (aprobado)</li>
                                        <li><strong>DNI/CC:</strong> 12345678</li>
                                        <li><strong>Email:</strong> test@example.com</li>
                                    </ul>
                                    <small>Usar "APRO" para pago aprobado</small>
                                </div>
                            </div>
                        </div>

                        <!-- Estados de Prueba -->
                        <div class="alert alert-warning mb-4">
                            <h6><i class="bi bi-list-check me-2"></i>‚úÖ Estados de Prueba (usar como nombre):</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="mb-0">
                                        <li><strong>APRO:</strong> Pago aprobado ‚úÖ</li>
                                        <li><strong>CONT:</strong> Pago pendiente ‚è≥</li>
                                        <li><strong>OTHE:</strong> Rechazado (error general) ‚ùå</li>
                                        <li><strong>CALL:</strong> Rechazado (autorizaci√≥n) üìû</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="mb-0">
                                        <li><strong>FUND:</strong> Fondos insuficientes üí∏</li>
                                        <li><strong>SECU:</strong> CVV inv√°lido üîí</li>
                                        <li><strong>EXPI:</strong> Fecha expirada üìÖ</li>
                                        <li><strong>FORM:</strong> Error en formulario üìù</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Producto de Prueba -->
                        <h5><i class="bi bi-bag me-2"></i>üõí Producto de Prueba</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Pantal√≥n Tela Galleta Verde</h6>
                                        <p class="text-muted">Talla: 30 | Color: Verde</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="h5 text-primary mb-0">$109.999</span>
                                            <button class="btn btn-primary" onclick="testPaymentFlow()">
                                                <i class="bi bi-credit-card me-2"></i>üí≥ Probar Pago
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6><i class="bi bi-gear me-2"></i>Configuraci√≥n Actual</h6>
                                        <div id="config-status">Cargando...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Estado del Pago -->
                        <div id="payment-status" class="mt-3"></div>
                        
                        <!-- Botones de Prueba Adicionales -->
                        <div class="mt-4">
                            <h6><i class="bi bi-tools me-2"></i>Pruebas Adicionales:</h6>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="testModalFlow()">
                                    Modal de Pago
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="testCartFlow()">
                                    Flujo de Carrito
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="testConfig()">
                                    Verificar Config
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                            </ul>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="testPaymentFlow()">
                                <i class="bi bi-play-circle me-2"></i>Iniciar Test de Pago
                            </button>
                            <button class="btn btn-outline-primary" onclick="openMainSite()">
                                <i class="bi bi-arrow-right me-2"></i>Ir al Sitio Principal
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <h6>Pasos del Test:</h6>
                            <ol>
                                <li>Se simular√° agregar un producto al carrito</li>
                                <li>Se abrir√° el modal del carrito</li>
                                <li>Se proceder√° al env√≠o</li>
                                <li>Se abrir√° el modal de pago</li>
                                <li>Se verificar√° que todo funcione correctamente</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config/mercadopago-config.js"></script>
    
    <script>
        // Funci√≥n para probar el flujo de pago
        function testPaymentFlow() {
            const statusDiv = document.getElementById('payment-status');
            statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-clock me-2"></i>üîÑ Creando preferencia de pago...</div>';

            // Datos del producto de prueba
            const testProduct = {
                items: [{
                    id: "test-001",
                    title: "Pantal√≥n Tela Galleta Verde",
                    description: "Producto de prueba - Talla 30, Color Verde",
                    picture_url: window.location.origin + "/Musa/uploads/product_68c1ee8e67cad_1757539982.jpeg",
                    category_id: "pantalones",
                    quantity: 1,
                    currency_id: "COP",
                    unit_price: 109999
                }],
                payer: {
                    name: "Usuario",
                    surname: "Prueba",
                    email: "test@example.com",
                    phone: {
                        area_code: "57",
                        number: "3001234567"
                    },
                    identification: {
                        type: "CC",
                        number: "12345678"
                    }
                },
                shipments: {
                    cost: 0,
                    mode: "not_specified"
                },
                back_urls: {
                    success: window.location.origin + "/Musa/success.html",
                    failure: window.location.origin + "/Musa/failure.html", 
                    pending: window.location.origin + "/Musa/pending.html"
                },
                auto_return: "approved",
                external_reference: "test-order-" + Date.now(),
                notification_url: window.location.origin + "/Musa/api/webhook.php"
            };

            console.log('üîç Enviando datos de pago:', testProduct);

            // Crear preferencia
            fetch('api/create-preference.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testProduct)
            })
            .then(response => {
                console.log('üîç Respuesta del servidor:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üîç Datos recibidos:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.init_point) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>‚úÖ Preferencia creada exitosamente!
                            <div class="mt-3">
                                <a href="${data.init_point}" class="btn btn-success" target="_blank">
                                    <i class="bi bi-credit-card me-2"></i>üí≥ Ir a MercadoPago
                                </a>
                                <button class="btn btn-outline-primary ms-2" onclick="copyToClipboard('${data.init_point}')">
                                    <i class="bi bi-clipboard me-2"></i>Copiar URL
                                </button>
                            </div>
                        </div>
                        <div class="alert alert-info mt-2">
                            <small>
                                <strong>ID:</strong> ${data.id}<br>
                                <strong>URL:</strong> <code>${data.init_point}</code>
                            </small>
                        </div>
                    `;
                } else {
                    throw new Error('No se recibi√≥ init_point en la respuesta');
                }
            })
            .catch(error => {
                console.error('‚ùå Error:', error);
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>‚ùå Error: ${error.message}
                        <div class="mt-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="showDebugInfo()">
                                Ver Detalles de Debug
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // Funci√≥n para probar el modal de pago
        function testModalFlow() {
            alert('üöß Funci√≥n en desarrollo: Abrir√≠a el modal de pago integrado');
        }

        // Funci√≥n para probar el flujo del carrito
        function testCartFlow() {
            // Redirigir a la p√°gina principal para probar el carrito real
            if (confirm('¬øIr a la p√°gina principal para probar el carrito real?')) {
                window.location.href = 'index.html';
            }
        }

        // Funci√≥n para verificar configuraci√≥n
        function testConfig() {
            try {
                const config = getMercadoPagoConfig();
                document.getElementById('payment-status').innerHTML = `
                    <div class="alert alert-info">
                        <h6><i class="bi bi-gear me-2"></i>Configuraci√≥n MercadoPago:</h6>
                        <ul>
                            <li><strong>Modo:</strong> ${isTestMode() ? 'TEST üß™' : 'PRODUCTION üöÄ'}</li>
                            <li><strong>Public Key:</strong> ${config.PUBLIC_KEY.substring(0, 15)}...</li>
                            <li><strong>Access Token:</strong> ${config.ACCESS_TOKEN.substring(0, 15)}...</li>
                            <li><strong>Moneda:</strong> ${config.PAYMENT_CONFIG.currency}</li>
                            <li><strong>Pa√≠s:</strong> ${config.PAYMENT_CONFIG.country}</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                document.getElementById('payment-status').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>‚ùå Error de configuraci√≥n: ${error.message}
                    </div>
                `;
            }
        }

        // Funci√≥n para copiar al portapapeles
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ URL copiada al portapapeles');
            }).catch(() => {
                alert('‚ùå Error al copiar al portapapeles');
            });
        }

        // Funci√≥n para mostrar informaci√≥n de debug
        function showDebugInfo() {
            const debugInfo = {
                url: window.location.href,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                config: {
                    mode: isTestMode() ? 'TEST' : 'PRODUCTION',
                    hasConfig: typeof getMercadoPagoConfig === 'function'
                }
            };

            document.getElementById('payment-status').innerHTML += `
                <div class="alert alert-secondary mt-2">
                    <h6><i class="bi bi-bug me-2"></i>Informaci√≥n de Debug:</h6>
                    <pre><code>${JSON.stringify(debugInfo, null, 2)}</code></pre>
                </div>
            `;
        }

        // Verificar configuraci√≥n al cargar
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const config = getMercadoPagoConfig();
                document.getElementById('config-status').innerHTML = `
                    <div class="text-success">
                        <i class="bi bi-check-circle me-1"></i>‚úÖ Configuraci√≥n OK
                    </div>
                    <small class="text-muted">
                        Modo: ${isTestMode() ? 'TEST üß™' : 'PRODUCTION üöÄ'}<br>
                        Public Key: ${config.PUBLIC_KEY.substring(0, 10)}...
                    </small>
                `;
                console.log('‚úÖ Configuraci√≥n MercadoPago cargada:', {
                    mode: isTestMode() ? 'TEST' : 'PRODUCTION',
                    public_key: config.PUBLIC_KEY.substring(0, 10) + '...'
                });
            } catch (error) {
                console.error('‚ùå Error de configuraci√≥n:', error);
                document.getElementById('config-status').innerHTML = `
                    <div class="text-danger">
                        <i class="bi bi-exclamation-triangle me-1"></i>‚ùå Error de Config
                    </div>
                    <small class="text-danger">${error.message}</small>
                `;
                document.getElementById('payment-status').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>‚ùå Error de configuraci√≥n: ${error.message}
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
